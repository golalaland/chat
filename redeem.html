<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
<title>Xixi Redeem</title>
<link rel="icon" href="data:," />
<style>
:root{
  --bg:#0a0a0a;
  --card:#111;
  --muted:#888;
  --accent:#0ff;          /* Neon cyan */
  --accent-light:#33ffff; /* Slightly lighter neon */
  --border:#222;
}
html,body{
  height:100%;margin:0;
  font-family: Inter,system-ui,Segoe UI,Roboto,"Helvetica Neue",Arial;
  background:var(--bg);color:#eee;
}
#appWrapper{width:100%;min-height:100%;display:flex;justify-content:center;}
.app{display:flex;flex-direction:column;min-height:100%;gap:10px;padding:10px;box-sizing:border-box;width:100%;max-width:480px;}
.brand{
  font-weight:700;font-size:24px;text-align:center;
  color:var(--accent);margin-bottom:10px;
  text-shadow:0 0 8px var(--accent);
}
#authBox{display:flex;justify-content:center;margin:20px 0;}
.google-btn{
  display:flex;align-items:center;gap:8px;padding:12px 20px;border-radius:999px;
  background:var(--accent);color:#000;font-weight:600;font-size:14px;
  border:none;cursor:pointer;box-shadow:0 0 12px rgba(0,255,255,0.4);
  transition:all .2s;
}
.google-btn img{width:18px;height:18px;background:#fff;border-radius:4px;padding:2px;}
.google-btn:hover{background:var(--accent-light);box-shadow:0 0 16px rgba(0,255,255,0.6);}
.profile{display:none;flex-direction:column;gap:12px;width:100%;}
.profile-card{
  background:var(--card);
  padding:16px;border-radius:16px;
  border:1px solid var(--border);
  display:flex;flex-direction:column;align-items:center;gap:12px;
  box-shadow:0 0 20px rgba(0,255,255,0.05);
}
.picture-frame{width:100%;aspect-ratio:1/1;overflow:hidden;border-radius:12px;display:flex;justify-content:center;align-items:center;position:relative;}
.picture-frame img{width:100%;height:100%;object-fit:cover;position:absolute;top:0;left:0;opacity:0;transition:opacity .6s;}
.picture-frame img.active{opacity:1;}
.profile-stats{display:flex;flex-direction:column;align-items:center;gap:6px;margin-top:10px;}
.profile-label{font-weight:600;color:var(--muted);font-size:14px;}
.profile-value{font-family:ui-monospace, Menlo, Monaco,"Roboto Mono",monospace;color:var(--accent);font-size:16px;text-shadow:0 0 6px rgba(0,255,255,0.6);}
.exit-btn{
  padding:10px 0;border-radius:999px;
  background:var(--accent);border:0;color:#000;font-weight:700;font-size:14px;
  cursor:pointer;margin-top:10px;transition:all .2s;width:100%;
  box-shadow:0 0 12px rgba(0,255,255,0.4);
}
.exit-btn:hover{background:var(--accent-light);transform:translateY(-2px);box-shadow:0 0 16px rgba(0,255,255,0.6);}
.redeem-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:12px;width:100%;}
.perk-card{
  background:var(--card);padding:12px;border-radius:12px;border:1px solid var(--border);
  cursor:pointer;transition:all .2s;text-align:center;
  box-shadow:0 0 8px rgba(0,255,255,0.1);
}
.perk-card:hover{transform:translateY(-2px);box-shadow:0 0 16px rgba(0,255,255,0.4);}
.perk-card.disabled{opacity:0.5;pointer-events:none;}
.perk-card .perk-name{font-weight:700;color:#eee;margin-bottom:4px;}
.perk-card .perk-cost{font-family:ui-monospace,Menlo,Monaco,"Roboto Mono","Courier New",monospace;color:var(--accent);}
.perk-card .perk-stock{font-size:12px;color:var(--muted);margin-top:4px;}
.popup-confirm{
  position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);
  background:var(--card);padding:20px;border-radius:12px;
  border:1px solid var(--border);display:none;flex-direction:column;
  align-items:center;gap:12px;z-index:1000;color:#eee;
  box-shadow:0 0 20px rgba(0,255,255,0.3);
}
.popup-confirm button{
  padding:8px 16px;border-radius:999px;border:0;font-weight:700;cursor:pointer;
}
.popup-confirm button:not(.cancel){
  background:var(--accent);color:#000;box-shadow:0 0 12px rgba(0,255,255,0.4);
}
.popup-confirm button:not(.cancel):hover{background:var(--accent-light);}
.popup-confirm button.cancel{
  background:#1a1a1a;color:#eee;border:1px solid var(--border);
}
</style>
</head>
<body>
<div id="appWrapper">
  <div class="app">
    <div class="brand">乂丨乂丨 REDEEM</div>

    <!-- Google sign-in -->
    <div id="authBox">
      <button id="googleSignInBtn" class="google-btn">
        <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" alt="Google logo">
        Sign in with Google
      </button>
    </div>

    <!-- Profile -->
    <div class="profile" id="profileBox">
      <div class="profile-card">
        <div class="picture-frame" id="pictureFrame">
          <img src="https://placekitten.com/400/400" class="active">
          <img src="https://placekitten.com/401/400">
          <img src="https://placekitten.com/402/400">
        </div>

        <!-- Centered Profile Stats -->
        <div class="profile-stats">
          <div id="profileName" style="font-size:28px;font-weight:700;"></div>
          <div class="profile-row">
            <span class="profile-label">Stars Collected:</span>
            <span class="profile-value" id="starsCollected">0 ⭐️</span>
          </div>
          <div class="profile-row">
            <span class="profile-label">Stars Balance:</span>
            <span class="profile-value" id="starsBalance">0 ⭐️</span>
          </div>
          <div class="profile-row">
            <span class="profile-label">Cash Collected:</span>
            <span class="profile-value" id="cashCollected">₦0</span>
          </div>
          <div class="profile-row">
            <span class="profile-label">Cash Balance:</span>
            <span class="profile-value" id="cashBalance">₦0</span>
          </div>
        </div>

        <!-- Redeem Grid -->
        <div class="redeem-grid" id="redeemGrid"></div>

        <button class="exit-btn" onclick="window.location.href='#'">Back to Chatroom</button>
      </div>
    </div>
  </div>
</div>

<!-- Redeem confirmation popup -->
<div class="popup-confirm" id="redeemPopup">
  <div id="redeemText">Are you sure you want to redeem?</div>
  <div style="display:flex;gap:10px;">
    <button id="redeemYes">Yes</button>
    <button class="cancel" id="redeemCancel">Cancel</button>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getAuth, setPersistence, browserLocalPersistence, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, signInWithRedirect } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
import { getFirestore, doc, setDoc, getDoc, updateDoc, collection, addDoc, serverTimestamp, increment } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyDbKz4ef_eUDlCukjmnK38sOwueYuzqoao",
  authDomain: "metaverse-1010.firebaseapp.com",
  projectId: "metaverse-1010",
  storageBucket: "metaverse-1010.appspot.com",
  messagingSenderId: "1044064238233",
  appId: "1:1044064238233:web:2fbdfb811cb0a3ba349608"
};
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
setPersistence(auth,browserLocalPersistence).catch(()=>{});
const db = getFirestore(app);

const googleBtn = document.getElementById("googleSignInBtn");
const authBox = document.getElementById("authBox");
const profileBoxEl = document.getElementById("profileBox");
const profileNameEl = document.getElementById("profileName");
const starsCollectedEl = document.getElementById("starsCollected");
const starsBalanceEl = document.getElementById("starsBalance");
const cashCollectedEl = document.getElementById("cashCollected");
const cashBalanceEl = document.getElementById("cashBalance");
const redeemGridEl = document.getElementById("redeemGrid");
const redeemPopupEl = document.getElementById("redeemPopup");
const redeemTextEl = document.getElementById("redeemText");
const redeemYesBtn = document.getElementById("redeemYes");
const redeemCancelBtn = document.getElementById("redeemCancel");

let currentUser = null;
let selectedPerk = null;

const perks = [
  {name:"VIP Badge", cost:50, available:8},
  {name:"Sticker Pack", cost:30, available:10},
  {name:"Custom Emoji", cost:70, available:5},
  {name:"Profile Highlight", cost:100, available:3},
  {name:"Animated Frame", cost:150, available:6},
  {name:"Extra Star Boost", cost:80, available:12},
  {name:"Cash Booster", cost:120, available:7},
  {name:"Mini Game Unlock", cost:90, available:9},
  {name:"Special Avatar", cost:110, available:4},
  {name:"Lucky Spin", cost:60, available:15},
  {name:"Exclusive Badge", cost:200, available:2},
  {name:"Golden Crown", cost:300, available:1}
];

// Google Sign-In
googleBtn.addEventListener("click",async()=>{
  const provider = new GoogleAuthProvider();
  try{ await signInWithPopup(auth,provider); }catch(err){ await signInWithRedirect(auth,provider); }
});

onAuthStateChanged(auth,async(user)=>{
  if(user){
    authBox.style.display="none";
    profileBoxEl.style.display="flex";
    const userRef = doc(db,"users",user.uid);
    let snap = await getDoc(userRef);
    if(!snap.exists()){
      await setDoc(userRef,{
        chatId:user.displayName||"GUEST",
        stars:200,
        cash:500,
        starsCollected:200,
        cashCollected:500
      });
      snap = await getDoc(userRef);
    }
    const data = snap.data();
    currentUser={uid:user.uid,...data};
    profileNameEl.innerText=data.chatId;

    starsCollectedEl.innerText = `${data.starsCollected} ⭐️`;
    starsBalanceEl.innerText = `${data.stars} ⭐️`;
    cashCollectedEl.innerText = `₦${data.cashCollected.toLocaleString()}`;
    cashBalanceEl.innerText = `₦${data.cash.toLocaleString()}`;

    renderPerks();
  } else { authBox.style.display="flex"; profileBoxEl.style.display="none"; }
});

function renderPerks(){
  redeemGridEl.innerHTML="";
  perks.forEach(p=>{
    const div = document.createElement("div");
    div.className="perk-card";
    if(p.available<=0){ div.classList.add("disabled"); }
    div.innerHTML=`
      <div class="perk-name">${p.name}</div>
      <div class="perk-cost">${p.cost} ⭐️</div>
      <div class="perk-stock">${p.available>0 ? p.available+" available today" : "Sold Out"}</div>
    `;
    if(p.available>0){
      div.addEventListener("click",()=>{
        if(currentUser.stars < p.cost){ alert("Not enough stars!"); return; }
        selectedPerk=p;
        redeemTextEl.innerText=`Are you sure you want to redeem ${p.name} for ${p.cost} ⭐️?`;
        redeemPopupEl.style.display="flex";
      });
    }
    redeemGridEl.appendChild(div);
  });
}

// Redeem popup buttons
redeemCancelBtn.addEventListener("click",()=>{ redeemPopupEl.style.display="none"; });
redeemYesBtn.addEventListener("click",async()=>{
  if(selectedPerk){
    const userRef = doc(db,"users",currentUser.uid);
    await updateDoc(userRef,{stars:increment(-selectedPerk.cost)});
    currentUser.stars -= selectedPerk.cost;
    starsBalanceEl.innerText=`${currentUser.stars} ⭐️`;

    selectedPerk.available--;
    renderPerks();

    redeemPopupEl.style.display="none";
    await addDoc(collection(db,"adminMessages"),{
      message:`${currentUser.chatId} redeemed ${selectedPerk.name}, please gift ${currentUser.chatId}`,
      timestamp:serverTimestamp()
    });

    const msg=document.createElement("div");
    msg.innerText=`Successfully redeemed ${selectedPerk.name}!`;
    msg.style.color="var(--accent)";
    msg.style.marginTop="10px";
    profileBoxEl.appendChild(msg);
    setTimeout(()=>msg.remove(),3000);
  }
});

// Picture slideshow
let slideIndex = 0;
setInterval(()=>{
  const imgs = document.querySelectorAll("#pictureFrame img");
  imgs.forEach(img=>img.classList.remove("active"));
  slideIndex=(slideIndex+1)%imgs.length;
  imgs[slideIndex].classList.add("active");
},4000);
</script>
</body>
</html>