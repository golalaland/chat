<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
<title>Xixi Redeem</title>
<link rel="icon" href="data:," />
<style>
:root{
  --bg:#000;
  --card:#111;
  --muted:#aaa;
  --accent:#FF1493;
  --glass: rgba(255,255,255,0.03);
}
html,body{height:100%;margin:0;font-family:'XiXi',Inter,system-ui,Segoe UI,Roboto,"Helvetica Neue",Arial;color:#fff;background:var(--bg);}
#appWrapper{width:100%;height:100%;display:flex;justify-content:center;}
.app{display:flex;flex-direction:column;height:100%;gap:10px;padding:10px;box-sizing:border-box;width:100%;max-width:480px;}
.brand{font-weight:700;font-size:24px;color:var(--accent);text-align:center;}
#helloText{font-size:20px;font-weight:800;text-align:center;margin:6px 0;color:#fff;transition:color .2s ease;}
#center{flex:1;display:flex;flex-direction:column;gap:6px;overflow-y:auto;}

/* Profile glass card */
.profile{display:none;flex-direction:column;gap:8px;margin-top:10px;}
.profile-card{background:var(--glass);backdrop-filter:blur(12px);padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,0.04);display:flex;flex-direction:column;gap:6px;}
.profile-row{display:flex;justify-content:space-between;font-size:14px;}
.profile-label{font-weight:800;color:var(--accent);}
.profile-value{font-family:monospace;font-weight:300;color:#fff;margin-left:6px;}

/* Redeem shop */
.redeem-shop{display:flex;flex-wrap:wrap;gap:8px;margin-top:10px;}
.item-card{flex:1 1 45%;background:var(--glass);backdrop-filter:blur(10px);padding:8px;border-radius:10px;text-align:center;cursor:pointer;border:1px solid rgba(255,20,147,0.18);}
.item-name{font-weight:700;color:var(--accent);}
.item-cost{font-family:monospace;font-size:14px;margin-top:4px;}
.item-stock{font-family:monospace;font-size:12px;margin-top:2px;color:#fff;}

/* Button */
.google-btn{
  display:flex;
  align-items:center;
  justify-content:center;
  gap:8px;
  padding:12px 20px;
  border-radius:999px;
  background:linear-gradient(135deg,#FF69B4,#FF1493);
  color:#fff;
  font-weight:600;
  font-size:14px;
  border:none;
  cursor:pointer;
  box-shadow:0 4px 10px rgba(255,20,147,0.4);
  transition:transform .2s, box-shadow .2s;
}
.google-btn:hover{transform:translateY(-2px);box-shadow:0 6px 14px rgba(255,20,147,0.6);}
.google-btn img{width:18px;height:18px;background:#fff;border-radius:4px;padding:2px;}
</style>
</head>
<body>
<div id="appWrapper">
  <div class="app">
    <div class="brand">乂丨乂丨</div>
    <div id="helloText">HELLO</div>

    <!-- Google Sign-In -->
    <div id="authBox">
      <button id="googleSignInBtn" class="google-btn">
        <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" alt="Google logo">
        Sign in with Google
      </button>
    </div>

    <!-- Profile -->
    <div class="profile" id="profileBox">
      <div class="profile-card">
        <div class="profile-row"><span class="profile-label">Name:</span><span class="profile-value" id="profileName">GUEST</span></div>
        <div class="profile-row"><span class="profile-label">Stars Collected:</span><span class="profile-value" id="starsCollected">0</span></div>
        <div class="profile-row"><span class="profile-label">Stars Balance:</span><span class="profile-value" id="starsBalance">0 ⭐️</span></div>
        <div class="profile-row"><span class="profile-label">Cash Collected:</span><span class="profile-value" id="cashCollected">₦0</span></div>
        <div class="profile-row"><span class="profile-label">Cash Balance:</span><span class="profile-value" id="cashBalance">₦0</span></div>
      </div>
    </div>

    <!-- Redeem shop -->
    <div class="redeem-shop" id="redeemShop" style="display:none;">
      <!-- Items will populate here -->
    </div>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getAuth, setPersistence, browserLocalPersistence, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, signInWithRedirect } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
import { getFirestore, doc, setDoc, getDoc, updateDoc, increment, collection, serverTimestamp, addDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

// Firebase config
const firebaseConfig = {
  apiKey: "AIzaSyDbKz4ef_eUDlCukjmnK38sOwueYuzqoao",
  authDomain: "metaverse-1010.firebaseapp.com",
  projectId: "metaverse-1010",
  storageBucket: "metaverse-1010.firebasestorage.app",
  messagingSenderId: "1044064238233",
  appId: "1:1044064238233:web:2fbdfb811cb0a3ba349608",
  measurementId: "G-S77BMC266C"
};
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
setPersistence(auth,browserLocalPersistence);
const db = getFirestore(app);

// UI refs
const googleBtn = document.getElementById("googleSignInBtn");
const authBox = document.getElementById("authBox");
const profileBox = document.getElementById("profileBox");
const profileNameEl = document.getElementById("profileName");
const starsCollectedEl = document.getElementById("starsCollected");
const starsBalanceEl = document.getElementById("starsBalance");
const cashCollectedEl = document.getElementById("cashCollected");
const cashBalanceEl = document.getElementById("cashBalance");
const redeemShopEl = document.getElementById("redeemShop");

let currentUser = null;

// Example redeem items
const REDEEM_ITEMS = [
  {id:'item1',name:'Cool Sticker',cost:50,stock:10},
  {id:'item2',name:'VIP Badge',cost:200,stock:5},
  {id:'item3',name:'Exclusive Hat',cost:500,stock:3}
];

// Populate redeem shop
function populateRedeemShop(){
  redeemShopEl.innerHTML = '';
  REDEEM_ITEMS.forEach(item=>{
    const div = document.createElement('div');
    div.className = 'item-card';
    div.dataset.cost = item.cost;
    div.dataset.stock = item.stock;
    div.innerHTML = `<div class="item-name">${item.name}</div>
                     <div class="item-cost">${item.cost} ⭐️</div>
                     <div class="item-stock">${item.stock} left today</div>`;
    redeemShopEl.appendChild(div);

    div.addEventListener('click', async ()=>{
      if(!currentUser) return alert("Sign in first!");
      const userRef = doc(db,'users',currentUser.uid);
      const snap = await getDoc(userRef);
      const stars = snap.data()?.stars || 0;
      let stock = parseInt(div.dataset.stock);

      if(stars >= item.cost && stock > 0){
        await updateDoc(userRef,{stars: increment(-item.cost)});
        div.dataset.stock = stock-1;
        div.querySelector('.item-stock').innerText = `${stock-1} left today`;
        starsBalanceEl.innerText = `${stars-item.cost} ⭐️`;

        // Admin notification
        await addDoc(collection(db,'admin_notifications'),{
          message:`${currentUser.displayName || currentUser.uid} redeemed ${item.name}. Please gift them.`,
          timestamp: serverTimestamp(),
          userId: currentUser.uid
        });
        alert(`Redeemed ${item.name}!`);
      } else if(stars < item.cost){
        alert("Not enough stars!");
      } else {
        alert("Item out of stock!");
      }
    });
  });
}

// Google Sign-In
googleBtn.addEventListener('click', async ()=>{
  const provider = new GoogleAuthProvider();
  try{
    await signInWithPopup(auth,provider);
  } catch(err){
    if(err.code === 'auth/popup-blocked' || err.code === 'auth/popup-closed-by-user'){
      await signInWithRedirect(auth,provider);
    } else alert(err.message || err);
  }
});

// Auth state
onAuthStateChanged(auth,async user=>{
  if(user){
    currentUser = user;
    authBox.style.display='none';
    profileBox.style.display='flex';
    redeemShopEl.style.display='flex';

    const userRef = doc(db,'users',user.uid);
    const snap = await getDoc(userRef);
    if(!snap.exists()){
      await setDoc(userRef,{
        chatId:user.displayName || user.email || "GUEST",
        stars:100,
        cash:0
      });
    }
    const data = (await getDoc(userRef)).data();
    profileNameEl.innerText = data.chatId;
    starsCollectedEl.innerText = data.stars;
    starsBalanceEl.innerText = `${data.stars} ⭐️`;
    cashCollectedEl.innerText = data.cash;
    cashBalanceEl.innerText = `₦${data.cash}`;

    populateRedeemShop();
  } else {
    currentUser = null;
    authBox.style.display='flex';
    profileBox.style.display='none';
    redeemShopEl.style.display='none';
  }
});
</script>
</body>
</html>