<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Hive Dashboard Signup/Login</title>
<style>
  body { font-family: sans-serif; text-align: center; }
  #signupForm input { margin: 5px; padding: 8px; width: 200px; }
  #signupForm button { padding: 8px 20px; margin-top: 10px; }
  #hiveDashboard { position: relative; width: 400px; height: 400px; margin: 20px auto; border: 1px solid #ccc; border-radius: 50%; }
  .circle {
    position: absolute;
    width: 80px;
    height: 80px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    text-align: center;
    color: white;
    font-weight: bold;
  }
  #mainGirl { background: #ff66aa; }
  .friendCircle { background: #66ccff; }
</style>
</head>
<body>

<h2 id="title">Join Chatroom</h2>

<form id="signupForm">
  <input type="text" id="name" placeholder="Name" required /><br/>
  <input type="date" id="dob" placeholder="DOB" required /><br/>
  <input type="tel" id="phone" placeholder="Phone Number" required /><br/>
  <input type="email" id="email" placeholder="Email Address" required /><br/>
  <input type="text" id="bankName" placeholder="Bank Name" required /><br/>
  <input type="text" id="accountNumber" placeholder="Account Number" required /><br/>
  <button type="submit" id="submitBtn">Sign Up / Login</button>
</form>

<div id="dashboard" style="display:none;">
  <h3>Welcome <span id="dashName"></span>!</h3>
  <p>Your referral link:</p>
  <input type="text" id="refLink" readonly />
  <button onclick="copyLink()">Copy Link</button>
  
  <p>Reward Balance: <span id="rewardBalance">0</span> ‚≠ê</p>
  
  <h4>Your Hive:</h4>
  <div id="hiveDashboard">
    <div id="mainGirl" class="circle">Main Girl</div>
  </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.25.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.25.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.25.0/firebase-firestore-compat.js"></script>

<script>
  // ---------------- Firebase Config ----------------
  const firebaseConfig = {
    apiKey: "YOUR_API_KEY",
    authDomain: "YOUR_AUTH_DOMAIN",
    projectId: "YOUR_PROJECT_ID"
  };
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.firestore();

  function generateReferralCode(name) {
    const randomNum = Math.floor(1000 + Math.random() * 9000);
    const initials = name.slice(0,3).toUpperCase();
    return initials + randomNum;
  }

  function copyLink() {
    const copyText = document.getElementById("refLink");
    copyText.select();
    document.execCommand("copy");
    alert("Referral link copied!");
  }

  async function showDashboard(uid) {
    const docSnap = await db.collection("girls").doc(uid).get();
    if (!docSnap.exists()) return;
    const data = docSnap.data();

    document.getElementById("dashName").textContent = data.name;
    document.getElementById("refLink").value = `${window.location.origin}/signup.html?ref=${data.referralCode}`;
    document.getElementById("rewardBalance").textContent = data.rewardBalance || 0;

    // Hive layout
    const hive = document.getElementById("hiveDashboard");
    // Set main girl in center
    const mainGirlDiv = document.getElementById("mainGirl");
    mainGirlDiv.textContent = data.name;

    // Clear previous friend circles
    document.querySelectorAll(".friendCircle").forEach(el => el.remove());

    const friends = data.friends || [];
    const centerX = 200, centerY = 200;
    const radius = 120;

    friends.forEach((friendId, index) => {
      const angle = (index / friends.length) * 2 * Math.PI;
      const x = centerX + radius * Math.cos(angle);
      const y = centerY + radius * Math.sin(angle);

      db.collection("girls").doc(friendId).get().then(friendDoc => {
        if (!friendDoc.exists) return;
        const fData = friendDoc.data();

        const friendDiv = document.createElement("div");
        friendDiv.className = "circle friendCircle";
        friendDiv.style.left = `${x - 40}px`;
        friendDiv.style.top = `${y - 40}px`;
        friendDiv.textContent = fData.name;

        hive.appendChild(friendDiv);
      });
    });

    document.getElementById("signupForm").style.display = "none";
    document.getElementById("dashboard").style.display = "block";
    document.getElementById("title").textContent = "Hive Dashboard";
  }

  document.getElementById("signupForm").addEventListener("submit", async (e) => {
    e.preventDefault();
    const name = document.getElementById("name").value;
    const dob = document.getElementById("dob").value;
    const phone = document.getElementById("phone").value;
    const email = document.getElementById("email").value;
    const bankName = document.getElementById("bankName").value;
    const accountNumber = document.getElementById("accountNumber").value;

    const urlParams = new URLSearchParams(window.location.search);
    const refCode = urlParams.get('ref');

    try {
      const tempPassword = "TempPass123!";
      let user;
      try {
        const userCredential = await auth.signInWithEmailAndPassword(email, tempPassword);
        user = userCredential.user;
        alert("Welcome back!");
      } catch(err) {
        if(err.code === "auth/user-not-found") {
          const userCredential = await auth.createUserWithEmailAndPassword(email, tempPassword);
          user = userCredential.user;

          let referralCode = generateReferralCode(name);
          let codeExists = await db.collection("girls").where("referralCode", "==", referralCode).get();
          while(!codeExists.empty) {
            referralCode = generateReferralCode(name);
            codeExists = await db.collection("girls").where("referralCode", "==", referralCode).get();
          }

          await db.collection("girls").doc(user.uid).set({
            name, dob, phone, email, bankName, accountNumber,
            referralCode,
            referredBy: refCode || null,
            friends: [],
            rewardBalance: 0,
            groupId: null
          });

          if(refCode) {
            const inviterQuery = await db.collection("girls").where("referralCode", "==", refCode).get();
            if(!inviterQuery.empty) {
              const inviterDoc = inviterQuery.docs[0];
              await inviterDoc.ref.update({
                friends: firebase.firestore.FieldValue.arrayUnion(user.uid)
              });
            }
          }
          alert("Signup successful!");
        } else throw err;
      }

      await showDashboard(user.uid);

    } catch(error) {
      console.error(error);
      alert("Error: " + error.message);
    }
  });
</script>
</body>
</html>