<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
<title>Redeem | Xixi</title>
<style>
:root{
  --bg:#000; --card:#111; --muted:#aaa; --accent:#FF1493; --glass: rgba(255,255,255,0.03);
}
body{margin:0;font-family:'XiXi',Inter,system-ui,Segoe UI,Roboto,"Helvetica Neue",Arial;color:#fff;background:var(--bg);}
#appWrapper{display:flex;flex-direction:column;align-items:center;padding:10px;}
.brand{font-weight:700;font-size:24px;color:var(--accent);text-align:center;margin:12px 0;}
.profile-card{background:var(--glass);padding:12px;border-radius:10px;border:1px solid rgba(255,255,255,0.04);width:100%;max-width:400px;margin-bottom:16px;}
.profile-name{font-weight:800;font-size:18px;}
.profile-stars{margin-top:4px;font-size:14px;color:var(--accent);}
.google-btn{display:flex;align-items:center;gap:8px;padding:12px 20px;border-radius:999px;background:linear-gradient(135deg,#FF69B4,#FF1493);color:#000;font-weight:700;font-size:14px;border:none;cursor:pointer;margin:20px 0;}
.google-btn img{width:18px;height:18px;border-radius:4px;padding:2px;}
.items-grid{display:flex;flex-wrap:wrap;gap:12px;justify-content:center;}
.item-card{background:var(--card);padding:12px;border-radius:10px;width:140px;text-align:center;cursor:pointer;transition:transform .15s, box-shadow .15s;}
.item-card:hover{transform:translateY(-2px);box-shadow:0 4px 10px rgba(255,20,147,0.3);}
.item-name{font-weight:600;margin-bottom:4px;}
.item-cost{color:var(--accent);font-weight:700;}
.star-popup{position:fixed;left:50%;top:18%;transform:translateX(-50%);background:var(--card);padding:8px 12px;border-radius:8px;border:1px solid rgba(255,255,255,0.05);display:none;z-index:1000;color:var(--accent);font-size:13px;text-align:center;}
</style>
</head>
<body>
<div id="appWrapper">
  <div class="brand">乂丨乂丨 Redeem</div>
  
  <!-- Profile info -->
  <div id="profileCard" class="profile-card" style="display:none;">
    <div id="profileName" class="profile-name"></div>
    <div id="starCount" class="profile-stars"></div>
  </div>

  <!-- Sign in -->
  <button id="googleSignInBtn" class="google-btn">
    <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" alt="Google logo">
    Sign in with Google
  </button>

  <!-- Redeem items -->
  <div id="itemsGrid" class="items-grid" style="display:none;">
    <div class="item-card" data-cost="50"><div class="item-name">Pink Badge</div><div class="item-cost">50 ⭐</div></div>
    <div class="item-card" data-cost="100"><div class="item-name">VIP Access</div><div class="item-cost">100 ⭐</div></div>
    <div class="item-card" data-cost="200"><div class="item-name">Gift Pack</div><div class="item-cost">200 ⭐</div></div>
  </div>
</div>

<div class="star-popup" id="starPopup">Redeemed!</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getAuth, setPersistence, browserLocalPersistence, GoogleAuthProvider, signInWithPopup, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
import { getFirestore, doc, setDoc, getDoc, updateDoc, increment } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyDbKz4ef_eUDlCukjmnK38sOwueYuzqoao",
  authDomain: "metaverse-1010.firebaseapp.com",
  projectId: "metaverse-1010",
  storageBucket: "metaverse-1010.firebasestorage.app",
  messagingSenderId: "1044064238233",
  appId: "1:1044064238233:web:2fbdfb811cb0a3ba349608",
  measurementId: "G-S77BMC266C"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
setPersistence(auth, browserLocalPersistence).catch(()=>{});
const db = getFirestore(app);

let currentUser = null;

// UI refs
const googleBtn = document.getElementById("googleSignInBtn");
const profileCard = document.getElementById("profileCard");
const profileNameEl = document.getElementById("profileName");
const starCountEl = document.getElementById("starCount");
const itemsGrid = document.getElementById("itemsGrid");
const starPopup = document.getElementById("starPopup");

function showStarPopup(text){
  starPopup.innerText = text;
  starPopup.style.display = "block";
  setTimeout(()=>{ starPopup.style.display="none"; }, 1500);
}

// Login flow
googleBtn.addEventListener("click", async ()=>{
  const provider = new GoogleAuthProvider();
  try {
    await setPersistence(auth, browserLocalPersistence);
    await signInWithPopup(auth, provider);
  } catch(e){ console.error("Login failed", e); alert("Sign-in failed. Check popup settings."); }
});

// After login
onAuthStateChanged(auth, async user=>{
  if(user){
    currentUser = user;
    googleBtn.style.display = "none";
    profileCard.style.display = "block";
    itemsGrid.style.display = "flex";

    // Ensure user doc exists
    const userRef = doc(db, "users", user.uid);
    const snap = await getDoc(userRef);
    if(!snap.exists()){
      await setDoc(userRef, { chatId: user.displayName || "Guest", stars: 100 });
    }
    const userData = (await getDoc(userRef)).data();
    profileNameEl.innerText = user.displayName || "Guest";
    starCountEl.innerText = `${userData.stars || 0} ⭐`;

    // Handle redeem
    document.querySelectorAll(".item-card").forEach(card=>{
      card.addEventListener("click", async ()=>{
        const cost = parseInt(card.dataset.cost);
        const snap2 = await getDoc(userRef);
        const stars = snap2.data()?.stars || 0;
        if(stars >= cost){
          await updateDoc(userRef, { stars: increment(-cost) });
          profileNameEl.innerText = user.displayName || "Guest";
          starCountEl.innerText = `${stars - cost} ⭐`;
          showStarPopup(`Redeemed ${card.querySelector(".item-name").innerText}!`);
        } else {
          showStarPopup("Not enough stars!");
        }
      });
    });

  } else {
    currentUser = null;
    googleBtn.style.display = "block";
    profileCard.style.display = "none";
    itemsGrid.style.display = "none";
  }
});
</script>
</body>
</html>