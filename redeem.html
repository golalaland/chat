<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>Perks Shop</title>
  <style>
    :root {
      --bg: #000;
      --card: #111;
      --muted: #aaa;
      --accent: #0f0;
    }
    body {
      background: var(--bg);
      color: #fff;
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
      text-align: center;
    }
    header {
      padding: 1rem;
      font-size: 1.2rem;
      font-weight: bold;
    }
    #starsBalance {
      font-size: 1rem;
      margin-top: 0.5rem;
      color: var(--accent);
    }
    .grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
      padding: 1rem;
    }
    .perk-card {
      background: var(--card);
      border-radius: 8px;
      padding: 1rem;
      cursor: pointer;
      transition: transform 0.2s;
    }
    .perk-card:hover {
      transform: scale(1.03);
    }
    .perk-name {
      font-weight: bold;
      margin-bottom: 0.3rem;
    }
    .perk-cost {
      color: gold;
      margin-bottom: 0.3rem;
    }
    .perk-available {
      font-size: 0.85rem;
      color: var(--muted);
    }
    #redeemPopup {
      display: none;
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.8);
      justify-content: center;
      align-items: center;
    }
    #redeemPopup .box {
      background: var(--card);
      padding: 1.5rem;
      border-radius: 8px;
    }
    .toast {
      visibility: hidden;
      min-width: 200px;
      background: #222;
      color: #fff;
      text-align: center;
      border-radius: 8px;
      padding: 10px;
      position: fixed;
      bottom: 30px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 999;
    }
    .toast.show {
      visibility: visible;
      animation: fadein 0.5s, fadeout 0.5s 2.5s;
    }
    @keyframes fadein {
      from {bottom: 10px; opacity: 0;}
      to {bottom: 30px; opacity: 1;}
    }
    @keyframes fadeout {
      from {bottom: 30px; opacity: 1;}
      to {bottom: 10px; opacity: 0;}
    }
  </style>
</head>
<body>
  <header>
    üåü Perks Shop  
    <div id="starsBalance">Stars: 0 ‚≠êÔ∏è</div>
  </header>

  <div class="grid" id="redeemGrid"></div>

  <div id="redeemPopup">
    <div class="box">
      <div id="redeemText"></div>
      <button id="redeemYes">Yes</button>
      <button onclick="redeemPopupEl.style.display='none'">Cancel</button>
    </div>
  </div>

  <div id="successToast" class="toast"></div>

  <!-- Firebase -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { 
      getFirestore, doc, getDoc, setDoc, updateDoc, increment, 
      collection, addDoc, serverTimestamp, onSnapshot 
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    // TODO: Replace with your Firebase config
  
const firebaseConfig = {
¬† apiKey: "AIzaSyDbKz4ef_eUDlCukjmnK38sOwueYuzqoao",
¬† authDomain: "metaverse-1010.firebaseapp.com",
¬† projectId: "metaverse-1010",
¬† storageBucket: "metaverse-1010.firebasestorage.app",
¬† messagingSenderId: "1044064238233",
¬† appId: "1:1044064238233:web:2fbdfb811cb0a3ba349608",
¬† measurementId: "G-S77BMC266C"
};

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // === Elements ===
    const starsBalanceEl = document.getElementById("starsBalance");
    const redeemGridEl = document.getElementById("redeemGrid");
    const redeemPopupEl = document.getElementById("redeemPopup");
    const redeemTextEl = document.getElementById("redeemText");
    const redeemYesBtn = document.getElementById("redeemYes");
    const successToastEl = document.getElementById("successToast");

    // === Demo user (replace with auth user later) ===
    let currentUser = { uid: "demoUser1", chatId: "User#1", stars: 500 };

    // === Perks Config ===
    const basePerks = [
      { name: "VIP Badge", cost: 50, dailyQty: 8 },
      { name: "Sticker Pack", cost: 30, dailyQty: 6 },
      { name: "Custom Emoji", cost: 70, dailyQty: 10 },
      { name: "Profile Highlight", cost: 100, dailyQty: 5 },
      { name: "Animated Frame", cost: 150, dailyQty: 4 },
      { name: "Extra Star Boost", cost: 80, dailyQty: 7 },
      { name: "Cash Booster", cost: 120, dailyQty: 3 },
      { name: "Mini Game Unlock", cost: 90, dailyQty: 9 },
      { name: "Special Avatar", cost: 110, dailyQty: 6 },
      { name: "Lucky Spin", cost: 60, dailyQty: 12 },
      { name: "Exclusive Badge", cost: 200, dailyQty: 2 },
      { name: "Golden Crown", cost: 300, dailyQty: 1 },
      { name: "Diamond Wings", cost: 250, dailyQty: 2 },
      { name: "Premium Chatroom", cost: 180, dailyQty: 4 }
    ];

    let selectedPerk = null;

    function todayId() {
      return new Date().toISOString().slice(0,10);
    }

    async function loadPerksForToday() {
      const today = todayId();
      const perksRef = doc(db, "perksDaily", today);
      let snap = await getDoc(perksRef);

      if (!snap.exists()) {
        let initData = {};
        basePerks.forEach(p => initData[p.name] = p.dailyQty);
        await setDoc(perksRef, initData);
        snap = await getDoc(perksRef);
      }
      return snap.data();
    }

    async function renderPerks() {
      const todayPerks = await loadPerksForToday();
      redeemGridEl.innerHTML = "";
      basePerks.forEach((p, i) => {
        const qty = todayPerks[p.name] ?? p.dailyQty;
        const div = document.createElement("div");
        div.className = "perk-card";
        div.innerHTML = `
          <div class="perk-name">${p.name}</div>
          <div class="perk-cost">${p.cost} ‚≠êÔ∏è</div>
          <div class="perk-available" id="perkAvail${i}" data-qty="${qty}">
            ${qty} available today
          </div>
        `;
        div.addEventListener("click", () => {
          if (qty <= 0) { alert("No more available today!"); return; }
          if (currentUser.stars < p.cost) { alert("Not enough stars!"); return; }
          selectedPerk = { ...p, index: i };
          redeemTextEl.innerText = `Redeem ${p.name} for ${p.cost} ‚≠êÔ∏è?`;
          redeemPopupEl.style.display = "flex";
        });
        redeemGridEl.appendChild(div);
      });
    }

    redeemYesBtn.addEventListener("click", async () => {
      if (!selectedPerk) return;
      const today = todayId();
      const perksRef = doc(db, "perksDaily", today);

      await updateDoc(perksRef, { [selectedPerk.name]: increment(-1) });
      currentUser.stars -= selectedPerk.cost;
      starsBalanceEl.innerText = `Stars: ${currentUser.stars} ‚≠êÔ∏è`;

      redeemPopupEl.style.display = "none";

      await addDoc(collection(db, "adminMessages"), {
        message: `${currentUser.chatId} redeemed ${selectedPerk.name}, please gift ${currentUser.chatId}`,
        timestamp: serverTimestamp()
      });

      successToastEl.innerText = `‚úÖ Successfully claimed ${selectedPerk.name}!`;
      successToastEl.classList.add("show");
      setTimeout(() => successToastEl.classList.remove("show"), 3000);
    });

    function listenForPerkUpdates() {
      const today = todayId();
      const perksRef = doc(db, "perksDaily", today);
      onSnapshot(perksRef, (snap) => {
        if (!snap.exists()) return;
        const data = snap.data();
        basePerks.forEach((p, i) => {
          const availEl = document.getElementById(`perkAvail${i}`);
          if (availEl) {
            availEl.innerText = `${data[p.name]} available today`;
            availEl.dataset.qty = data[p.name];
          }
        });
      });
    }

    // Init
    starsBalanceEl.innerText = `Stars: ${currentUser.stars} ‚≠êÔ∏è`;
    renderPerks();
    listenForPerkUpdates();
  </script>
</body>
</html>