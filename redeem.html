<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
<title>Xixi Redeem</title>
<link rel="icon" href="data:," />
<style>
:root{
  --bg:#f9fafc;
  --card:#fff;
  --muted:#666;
  --accent:#0066ff;
  --accent-light:#3399ff;
  --border:#e5e7eb;
}
html,body{
  height:100%;margin:0;
  font-family: Inter,system-ui,Segoe UI,Roboto,"Helvetica Neue",Arial;
  background:var(--bg);color:#111;
}
#appWrapper{
  width:100%;min-height:100%;
  display:flex;justify-content:center;align-items:flex-start;
  padding:20px;
}
.app{
  width:100%;max-width:460px;
  display:flex;flex-direction:column;
  gap:20px;
}
.brand{
  font-weight:700;font-size:22px;text-align:center;
  color:var(--accent);
}
#authBox{display:flex;justify-content:center;margin-top:30px;}
.google-btn{
  display:flex;align-items:center;gap:10px;
  padding:14px 20px;border-radius:12px;
  background:var(--accent);color:#fff;
  font-weight:600;font-size:15px;border:none;cursor:pointer;
  box-shadow:0 2px 6px rgba(0,0,0,0.15);
  transition:background .2s;
}
.google-btn:hover{background:var(--accent-light);}
.google-btn img{width:20px;height:20px;border-radius:4px;}
.profile{display:none;flex-direction:column;gap:20px;}
.profile-card{
  background:var(--card);border-radius:16px;
  padding:20px;
  border:1px solid var(--border);
  box-shadow:0 2px 10px rgba(0,0,0,0.05);
  display:flex;flex-direction:column;align-items:center;gap:20px;
}
.picture-frame{width:100%;aspect-ratio:1/1;border-radius:12px;overflow:hidden;}
.picture-frame img{width:100%;height:100%;object-fit:cover;display:none;}
.picture-frame img.active{display:block;}
.profile-stats{width:100%;display:flex;flex-direction:column;gap:12px;}
.balance-display{
  text-align:center;
}
.balance-name{
  font-size:14px;color:var(--muted);font-weight:500;
}
.balance-value{
  font-size:22px;font-weight:700;color:#111;
}
.row-stats{
  display:flex;justify-content:space-between;
  background:#f3f4f6;padding:12px 16px;
  border-radius:12px;font-size:14px;
}
.row-label{color:var(--muted);}
.row-value{font-weight:600;}
.redeem-grid{
  display:grid;grid-template-columns:1fr 1fr;gap:12px;width:100%;
}
.perk-card{
  background:var(--card);border-radius:12px;
  padding:14px;text-align:center;
  border:1px solid var(--border);
  cursor:pointer;transition:transform .15s,box-shadow .15s;
}
.perk-card:hover{transform:translateY(-2px);box-shadow:0 2px 8px rgba(0,0,0,0.08);}
.perk-name{font-weight:600;font-size:14px;margin-bottom:4px;}
.perk-cost{font-size:13px;color:var(--accent);}
.exit-btn{
  width:100%;padding:14px;
  border-radius:12px;background:var(--accent);
  color:#fff;font-weight:600;font-size:15px;border:none;cursor:pointer;
  transition:background .2s;
}
.exit-btn:hover{background:var(--accent-light);}
.popup-confirm{
  position:fixed;top:0;left:0;width:100%;height:100%;
  background:rgba(0,0,0,0.5);display:none;justify-content:center;align-items:center;z-index:1000;
}
.popup-card{
  background:var(--card);border-radius:16px;padding:24px;
  width:90%;max-width:360px;text-align:center;
  box-shadow:0 4px 20px rgba(0,0,0,0.15);
}
.popup-card p{font-size:15px;margin-bottom:20px;color:#111;}
.popup-actions{display:flex;gap:12px;justify-content:center;}
.popup-actions button{
  flex:1;padding:12px;border-radius:12px;border:none;font-weight:600;cursor:pointer;
}
.popup-actions .yes{background:var(--accent);color:#fff;}
.popup-actions .yes:hover{background:var(--accent-light);}
.popup-actions .cancel{background:#f3f4f6;color:#111;}
</style>
</head>
<body>
<div id="appWrapper">
  <div class="app">
    <div class="brand">乂丨乂丨 Redeem</div>

    <!-- Google sign-in -->
    <div id="authBox">
      <button id="googleSignInBtn" class="google-btn">
        <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" alt="Google logo">
        Sign in with Google
      </button>
    </div>

    <!-- Profile -->
    <div class="profile" id="profileBox">
      <div class="profile-card">
        <div class="picture-frame" id="pictureFrame">
          <img src="https://placekitten.com/400/400" class="active">
          <img src="https://placekitten.com/401/400">
          <img src="https://placekitten.com/402/400">
        </div>

        <div class="profile-stats">
          <div class="balance-display">
            <div class="balance-name">Stars Balance</div>
            <div class="balance-value" id="starsBalance">0 ⭐️</div>
          </div>
          <div class="balance-display">
            <div class="balance-name">Cash Balance</div>
            <div class="balance-value" id="cashBalance">₦0</div>
          </div>

          <div class="row-stats">
            <span class="row-label">Stars Collected</span>
            <span class="row-value" id="starsCollected">0 ⭐️</span>
          </div>
          <div class="row-stats">
            <span class="row-label">Cash Collected</span>
            <span class="row-value" id="cashCollected">₦0</span>
          </div>
        </div>

        <div class="redeem-grid" id="redeemGrid"></div>

        <button class="exit-btn" onclick="window.location.href='#'">Back to Chatroom</button>
      </div>
    </div>
  </div>
</div>

<!-- Redeem confirmation popup -->
<div class="popup-confirm" id="redeemPopup">
  <div class="popup-card">
    <p id="redeemText">Are you sure you want to redeem?</p>
    <div class="popup-actions">
      <button class="yes" id="redeemYes">Yes</button>
      <button class="cancel" id="redeemCancel">Cancel</button>
    </div>
  </div>
</div>

<script type="module">
// --- Firebase code unchanged ---
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getAuth, setPersistence, browserLocalPersistence, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, signInWithRedirect } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
import { getFirestore, doc, setDoc, getDoc, updateDoc, collection, addDoc, serverTimestamp, increment } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyDbKz4ef_eUDlCukjmnK38sOwueYuzqoao",
  authDomain: "metaverse-1010.firebaseapp.com",
  projectId: "metaverse-1010",
  storageBucket: "metaverse-1010.appspot.com",
  messagingSenderId: "1044064238233",
  appId: "1:1044064238233:web:2fbdfb811cb0a3ba349608"
};
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
setPersistence(auth,browserLocalPersistence).catch(()=>{});
const db = getFirestore(app);

const googleBtn = document.getElementById("googleSignInBtn");
const authBox = document.getElementById("authBox");
const profileBoxEl = document.getElementById("profileBox");
const starsCollectedEl = document.getElementById("starsCollected");
const starsBalanceEl = document.getElementById("starsBalance");
const cashCollectedEl = document.getElementById("cashCollected");
const cashBalanceEl = document.getElementById("cashBalance");
const redeemGridEl = document.getElementById("redeemGrid");
const redeemPopupEl = document.getElementById("redeemPopup");
const redeemTextEl = document.getElementById("redeemText");
const redeemYesBtn = document.getElementById("redeemYes");
const redeemCancelBtn = document.getElementById("redeemCancel");

let currentUser = null;
let selectedPerk = null;

const perks = [
  {name:"VIP Badge", cost:50},
  {name:"Sticker Pack", cost:30},
  {name:"Custom Emoji", cost:70},
  {name:"Profile Highlight", cost:100},
  {name:"Animated Frame", cost:150},
  {name:"Extra Star Boost", cost:80},
  {name:"Cash Booster", cost:120},
  {name:"Mini Game Unlock", cost:90},
  {name:"Special Avatar", cost:110},
  {name:"Lucky Spin", cost:60},
  {name:"Exclusive Badge", cost:200},
  {name:"Golden Crown", cost:300}
];

googleBtn.addEventListener("click",async()=>{
  const provider = new GoogleAuthProvider();
  try{ await signInWithPopup(auth,provider); }catch(err){ await signInWithRedirect(auth,provider); }
});

onAuthStateChanged(auth,async(user)=>{
  if(user){
    authBox.style.display="none";
    profileBoxEl.style.display="flex";
    const userRef = doc(db,"users",user.uid);
    let snap = await getDoc(userRef);
    if(!snap.exists()){
      await setDoc(userRef,{chatId:user.displayName||"GUEST",stars:200,cash:500});
      snap = await getDoc(userRef);
    }
    const data = snap.data();
    currentUser={uid:user.uid,...data};

    starsCollectedEl.innerText = `${data.stars} ⭐️`;
    starsBalanceEl.innerText = `${data.stars} ⭐️`;
    cashCollectedEl.innerText = `₦${data.cash.toLocaleString()}`;
    cashBalanceEl.innerText = `₦${data.cash.toLocaleString()}`;

    redeemGridEl.innerHTML="";
    perks.forEach(p=>{
      const div = document.createElement("div");
      div.className="perk-card";
      div.innerHTML=`<div class="perk-name">${p.name}</div><div class="perk-cost">${p.cost} ⭐️</div>`;
      div.addEventListener("click",()=>{
        if(currentUser.stars < p.cost){ alert("Not enough stars!"); return; }
        selectedPerk=p;
        redeemTextEl.innerText=`Redeem ${p.name} for ${p.cost} ⭐️?`;
        redeemPopupEl.style.display="flex";
      });
      redeemGridEl.appendChild(div);
    });

  } else { authBox.style.display="flex"; profileBoxEl.style.display="none"; }
});

redeemCancelBtn.addEventListener("click",()=>{ redeemPopupEl.style.display="none"; });
redeemYesBtn.addEventListener("click",async()=>{
  if(selectedPerk){
    const userRef = doc(db,"users",currentUser.uid);
    await updateDoc(userRef,{stars:increment(-selectedPerk.cost)});
    currentUser.stars -= selectedPerk.cost;
    starsBalanceEl.innerText=`${currentUser.stars} ⭐️`;
    redeemPopupEl.style.display="none";

    await addDoc(collection(db,"adminMessages"),{
      message:`${currentUser.chatId} redeemed ${selectedPerk.name}, please gift ${currentUser.chatId}`,
      timestamp:serverTimestamp()
    });
    alert(`Successfully redeemed ${selectedPerk.name}!`);
  }
});

// Slideshow
let slideIndex = 0;
setInterval(()=>{
  const imgs = document.querySelectorAll("#pictureFrame img");
  imgs.forEach(img=>img.classList.remove("active"));
  slideIndex=(slideIndex+1)%imgs.length;
  imgs[slideIndex].classList.add("active");
},4000);
</script>
</body>
</html>