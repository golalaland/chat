<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>VIP / Host Signup</title>
<style>
:root{
  --primary-color:#ff4081;
  --background-gradient:linear-gradient(135deg,#111,#000,#222);
  --text-color:#eee;
  --input-bg:#222;
  --input-border:#333;
}
*{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color: transparent;}
body{background:var(--background-gradient);color:var(--text-color);font-family:Inter,system-ui,Arial;display:flex;flex-direction:column;align-items:center;padding:1rem}
h2{font-size:1.2rem;color:var(--primary-color);margin-bottom:.25rem;text-align:center}
.form-group{width:90%;max-width:400px;margin-bottom:.7rem;display:flex;flex-direction:column;align-items:center;z-index:10}
.form-group input{width:100%;padding:.65rem 1rem;border-radius:30px;border:1px solid var(--input-border);background:var(--input-bg);color:var(--text-color);font-size:.95rem;outline:none}
.gender-label{text-align:center;font-weight:600;font-size:.8rem;margin-bottom:.3rem;z-index:10}
.gender-select{display:flex;justify-content:center;gap:25px;margin-bottom:1rem;z-index:10;position:relative}
.gender-select button{width:70px;height:70px;border-radius:50%;border:none;background:#333;color:#eee;font-weight:700;font-size:1.1rem;cursor:pointer;box-shadow:0 6px #000;transition:.18s;z-index:10;touch-action:manipulation}
.gender-select button:active{transform:translateY(3px);box-shadow:0 2px #000}
.gender-select button.selected{background:var(--primary-color);box-shadow:0 0 12px var(--primary-color)}
.dob-container{display:flex;flex-direction:column;align-items:center;margin-bottom:.7rem;z-index:10}
.dob-input{width:140px;padding:.5rem .8rem;border-radius:8px;border:1px solid var(--input-border);background:var(--input-bg);color:var(--text-color);font-size:.9rem;text-align:center;cursor:pointer}
.vip-label{text-align:center;font-weight:700;font-size:.85rem;margin-bottom:.3rem;color:#aaa;z-index:10}
.vip-toggle{width:90px;height:42px;border-radius:21px;background:#444;position:relative;cursor:pointer;margin:0 auto .6rem auto;transition:.2s;z-index:10;touch-action:manipulation}
.vip-toggle .vip-circle{width:38px;height:38px;border-radius:50%;background:#555;position:absolute;left:2px;top:2px;transition:.25s}
.vip-toggle.on .vip-circle{left:50px;background:gold;box-shadow:0 0 12px gold}
.vip-message{text-align:center;font-size:.8rem;color:gold;opacity:0;transition:.25s;margin-bottom:1rem;z-index:10}
.submit-btn{width:60%;padding:.65rem;border:none;border-radius:30px;font-weight:700;font-size:.95rem;color:#fff;background:var(--primary-color);cursor:pointer;margin-bottom:1rem;display:flex;justify-content:center;align-items:center;position:relative;z-index:10;touch-action:manipulation}
.submit-btn:disabled{opacity:.6;cursor:not-allowed}
.spinner{width:18px;height:18px;border:3px solid #fff;border-top:3px solid rgba(255,255,255,.35);border-radius:50%;animation:spin .7s linear infinite;display:none;margin-left:8px}
@keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}
.message{text-align:center;font-size:.9rem;min-height:22px;margin-top:.5rem;color:#ddd;z-index:10}
.fomo-popup{position:fixed;top:100px;left:50%;transform:translateX(-50%);background:#111;padding:.6rem 1rem;border-radius:8px;color:#fff;opacity:0;transition:opacity .4s;pointer-events:none;z-index:9999;display:flex;align-items:center;gap:.5rem;white-space:nowrap}
.image-placeholder{width:300px;height:300px;background:#333;border-radius:12px;margin-bottom:1rem;display:flex;align-items:center;justify-content:center;color:#aaa;z-index:5}
#paystackContainer{display:none;justify-content:center;width:100%;margin-bottom:1rem;z-index:10}
#paystackBtn{width:60%;max-width:250px;padding:.65rem;border-radius:30px;border:none;background:linear-gradient(45deg,gold,#ffd700);color:#000;font-weight:700;cursor:pointer}
#paystackBtn:disabled{opacity:.6;cursor:not-allowed}
</style>

<div class="gender-label">Select Your Gender</div>
<div class="gender-select">
  <button id="femaleBtn" type="button">F</button>
  <button id="maleBtn" type="button">M</button>
</div>

<div class="dob-container">
  <div class="dob-label">Select Your Birth Date</div>
  <input id="dob" type="date" class="dob-input" max="">
</div>

<div class="vip-label" id="vipLabel">VIP</div>
<div class="vip-toggle" id="vipToggle" role="button" aria-pressed="false">
  <span class="vip-circle"></span>
</div>
<div class="vip-message" id="vipMessage">You're in VIP zone, way to go!</div>

<button class="submit-btn" id="submitBtn"><span class="btn-text">Sign Up</span><span class="spinner" id="spinner"></span></button>

<div id="paystackContainer">
  <button class="submit-btn" id="paystackBtn"><span class="btn-text">VIP ACCESS</span><span class="spinner" id="paystackSpinner"></span></button>
</div>

<div class="message" id="message"></div>

<!-- Firebase + app script -->
<script type="module">
/* ---- FIREBASE + PAYSTACK hook (expects paystack.js export) ---- */
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getFirestore, doc, setDoc, getDoc, updateDoc, collection, query, where, getDocs, orderBy, limit, arrayUnion } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

let startPaystackSubscription = null;
try {
  // dynamic import may fail if paystack.js missing; that's okay — we guard later
  const pay = await import('./paystack.js');
  startPaystackSubscription = pay.startPaystackSubscription || pay.startPaystack || pay.default || null;
} catch(e){
  // paystack.js not available — we'll handle when clicking VIP button
  startPaystackSubscription = null;
}

/* Replace with your Firebase config (kept as in previous messages) */
const firebaseConfig = {
  apiKey: "AIzaSyDbKz4ef_eUDlCukjmnK38sOwueYuzqoao",
  authDomain: "metaverse-1010.firebaseapp.com",
  projectId: "metaverse-1010",
  storageBucket: "metaverse-1010.appspot.com",
  messagingSenderId: "1044064238233",
  appId: "1:1044064238233:web:2fbdfb811cb0a3ba349608"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

/* ---- DOM references ---- */
const nameInput = document.getElementById('name');
const chatIdInput = document.getElementById('chatId');
const phoneInput = document.getElementById('phone');
const emailInput = document.getElementById('email');
const dobInput = document.getElementById('dob');

const femaleBtn = document.getElementById('femaleBtn');
const maleBtn = document.getElementById('maleBtn');
const vipToggle = document.getElementById('vipToggle');
const vipLabel = document.getElementById('vipLabel');
const vipMessage = document.getElementById('vipMessage');

const submitBtn = document.getElementById('submitBtn');
const spinner = document.getElementById('spinner');
const messageEl = document.getElementById('message');

const fomoPopup = document.getElementById('fomoPopup');

const paystackContainer = document.getElementById('paystackContainer');
const paystackBtn = document.getElementById('paystackBtn');
const paystackSpinner = document.getElementById('paystackSpinner');

/* ---- state ---- */
let isVIP = false;
let gender = '';

/* ---- helpers ---- */
function sanitizeKey(key){ return (key||'').replace(/[.#$[\]]/g, ','); }
function cleanChatId(input){ return (input||'').toLowerCase().replace(/[^a-z0-9_]/g,''); }
function isValidEmail(email){
  const validEmailSuffixes = ['@gmail.com','@yahoo.com','@icloud.com','@proton.me','@protonmail.com'];
  return validEmailSuffixes.some(s => (email||'').endsWith(s));
}
function calculateAge(dobStr){
  if(!dobStr) return 0;
  const dob = new Date(dobStr);
  const diff = Date.now() - dob.getTime();
  const ageDt = new Date(diff);
  return Math.abs(ageDt.getUTCFullYear() - 1970);
}
async function isChatIdTaken(chatId){
  if(!chatId) return false;
  const q = query(collection(db,"users"), where("chatIdLower","==", chatId.toLowerCase()));
  const snap = await getDocs(q);
  return !snap.empty;
}
async function getUserCountry(){
  try{
    const r = await fetch('https://ipapi.co/json/');
    const j = await r.json();
    return j.country_name || 'Unknown';
  }catch(e){ return 'Unknown'; }
}

/* ---- UI wiring ---- */
phoneInput.addEventListener('input', ()=> { phoneInput.value = phoneInput.value.replace(/\D/g,''); });

femaleBtn.addEventListener('click', ()=>{ gender='Female'; femaleBtn.classList.add('selected'); maleBtn.classList.remove('selected'); });
maleBtn.addEventListener('click', ()=>{ gender='Male'; maleBtn.classList.add('selected'); femaleBtn.classList.remove('selected'); });

vipToggle.addEventListener('click', ()=>{
  isVIP = !isVIP;
  vipToggle.classList.toggle('on', isVIP);
  vipLabel.classList.toggle('on', isVIP);
  vipMessage.style.opacity = isVIP ? '1' : '0';
  vipToggle.setAttribute('aria-pressed', isVIP ? 'true': 'false');
  if(isVIP) { // confetti
    const colors = ['#FFD700','#FF69B4','#00BFFF','#FF4500','#32CD32'];
    for(let i=0;i<40;i++){
      const p = document.createElement('div');
      p.style.position='fixed'; p.style.width='6px'; p.style.height='14px';
      p.style.backgroundColor = colors[Math.floor(Math.random()*colors.length)];
      const rect = vipToggle.getBoundingClientRect();
      p.style.left = (rect.left + rect.width/2) + 'px';
      p.style.top = (rect.bottom) + 'px';
      p.style.zIndex = 9999; p.style.borderRadius='2px'; p.style.pointerEvents='none';
      document.body.appendChild(p);
      const angle = (Math.random()*Math.PI/2) - Math.PI/4;
      const speed = 250 + Math.random()*220;
      const dur = 1100 + Math.random()*800;
      const start = performance.now();
      (function anim(t0){
        const t = (performance.now() - start)/dur;
        if(t<1){
          const dx = Math.sin(angle) * speed * t;
          const dy = -Math.cos(angle) * speed * t;
          p.style.transform = `translate(${dx}px, ${dy}px) rotate(${t*720}deg)`;
          p.style.opacity = `${1 - t}`;
          requestAnimationFrame(anim);
        } else p.remove();
      })();
    }
  }
});

/* set dob max (18+) */
(function setDobMax(){
  const today = new Date();
  const max = new Date(today.getFullYear()-18, today.getMonth(), today.getDate());
  dobInput.max = max.toISOString().split('T')[0];
})();

/* ---- FOMO popups ---- */
async function fetchRecentUsers(){
  try{
    const q = query(collection(db,"users"), orderBy("createdAt","desc"), limit(10));
    const snap = await getDocs(q);
    const users = [];
    snap.forEach(s=>{
      const d = s.data();
      users.push({
        chatId: d.chatId || d.chatIdLower || 'someone',
        usernameColor: d.usernameColor || '#FFD700',
        isVIP: !!d.isVIP
      });
    });
    return users;
  }catch(e){ return []; }
}
async function showFomoLoop(){
  const users = await fetchRecentUsers();
  if(!users || users.length===0) return;
  let i = 0;
  setInterval(()=>{
    const u = users[i % users.length];
    fomoPopup.innerHTML = `<span style="font-weight:700;color:${u.usernameColor}">${u.chatId}</span> just joined as a ${u.isVIP ? 'VIP' : 'Host'} ${u.isVIP? '🎉' : '🎈'}`;
    fomoPopup.style.opacity = '1';
    setTimeout(()=> fomoPopup.style.opacity = '0', 3000);
    i++;
  }, 9000);
}
showFomoLoop();

/* ---- Save user (main) ---- */
async function saveUser(isVipPaid=false){
  spinner.style.display = 'inline-block';
  const originalBtnText = submitBtn.querySelector('.btn-text') || submitBtn;
  if(originalBtnText) originalBtnText.style.display = 'none';
  submitBtn.disabled = true;
  messageEl.textContent = '';

  const fullName = nameInput.value.trim();
  const chatIdRaw = chatIdInput.value.trim();
  const chatId = cleanChatId(chatIdRaw);
  const phone = phoneInput.value.trim();
  const email = emailInput.value.trim().toLowerCase();
  const dob = dobInput.value;
  const age = calculateAge(dob);

  // double-check
  if(!fullName||!chatId||!phone||!email||!dob||!gender){
    spinner.style.display='none';
    if(originalBtnText) originalBtnText.style.display='inline';
    submitBtn.disabled = false;
    messageEl.textContent = '❌ Please fill in all fields.';
    return;
  }
  if(age < 18){
    spinner.style.display='none';
    if(originalBtnText) originalBtnText.style.display='inline';
    submitBtn.disabled = false;
    messageEl.textContent = '❌ You must be 18+ to sign up.';
    return;
  }
  if(!isValidEmail(email)){
    spinner.style.display='none';
    if(originalBtnText) originalBtnText.style.display='inline';
    submitBtn.disabled = false;
    messageEl.textContent = '❌ Use a supported email domain.';
    return;
  }

  try{
    // check existing email or chatId
    const uidKey = sanitizeKey(email);
    const existing = await getDoc(doc(db,"users",uidKey));
    if(existing.exists()){
      spinner.style.display='none';
      if(originalBtnText) originalBtnText.style.display='inline';
      submitBtn.disabled = false;
      messageEl.textContent = '❌ Email already registered.';
      return;
    }
    if(await isChatIdTaken(chatId)){
      spinner.style.display='none';
      if(originalBtnText) originalBtnText.style.display='inline';
      submitBtn.disabled = false;
      messageEl.textContent = '❌ ChatID taken. Try another.';
      return;
    }

    // country by IP
    const country = await getUserCountry();

    const now = new Date();
    const usernameColor = '#'+Math.floor(Math.random()*16777215).toString(16);

    // subscription fields
    const subscriptionActive = !isVIP; // hosts (non-VIP) active by default, VIP will activate after payment
    const subscriptionActivatedAt = subscriptionActive ? now.toISOString() : null;
    const subscriptionEnd = null; // we set on payment

    const userData = {
      fullName,
      chatId,
      chatIdLower: chatId.toLowerCase(),
      phone,
      email,
      dob,
      age,
      gender,
      isVIP: !!isVIP,
      isHost: !isVIP,
      isAdmin: false,
      subscriptionActive,
      subscriptionActivatedAt,
      subscriptionEnd,
      vipName: null, // will set when VIP pays or later
      vipRefCode: null,
      hostLink: `https://golalaland.github.io/chat/ref.html?ref=${encodeURIComponent(chatId)}`,
      invitedBy: referrer || null,
      hostName: referrer || null,
      stars: 50,
      starsToday: 0,
      starsGifted: 0,
      lastStarDate: now.toISOString().split('T')[0],
      cash: 0,
      usernameColor,
      socialShare: !isVIP, // only hosts can share
      socialLinks: { whatsapp:'', instagram:'', tiktok:'', telegram:'' },
      BankName: null,
      BankAccountNumber: null,
      createdAt: now.toISOString(),
      country
    };

    // write to Firestore
    await setDoc(doc(db,"users",uidKey), userData);

    // referral gift to inviter (if exists)
    if(referrer){
      try{
        const refUid = sanitizeKey(referrer);
        const refDocRef = doc(db,"users",refUid);
        const refSnap = await getDoc(refDocRef);
        if(refSnap.exists()){
          const refData = refSnap.data();
          const bonus = isVIP ? 100 : 50;
          await updateDoc(refDocRef, {
            stars: (refData.stars || 0) + bonus,
            starsGifted: (refData.starsGifted || 0) + bonus,
            hostFriends: arrayUnion({ chatId, chatIdLower: chatId.toLowerCase(), isVIP: !!isVIP, gifted: bonus })
          });
        }
      }catch(e){ console.error('Referral update failed', e); }
    }

    // set autologin token (store uidKey; nushop will load user)
    localStorage.setItem('currentUser', uidKey);

    messageEl.textContent = '✅ Signup successful!';
    spinner.style.display='none';
    if(originalBtnText) originalBtnText.style.display='inline';
    submitBtn.disabled = false;

    if(!isVIP){
      // host => redirect immediately
      window.location.href = 'nushop.html';
    } else {
      // VIP => show VIP access button (calls paystack.js)
      paystackContainer.style.display = 'flex';
      // optionally hide signup button to avoid reclick
      submitBtn.style.display = 'none';
    }

  }catch(err){
    console.error(err);
    spinner.style.display='none';
    if(originalBtnText) originalBtnText.style.display='inline';
    submitBtn.disabled = false;
    messageEl.textContent = '❌ Signup failed. Try again.';
  }
}

/* ---- Sign-up button ---- */
submitBtn.addEventListener('click', async (e)=>{
  e.preventDefault();
  messageEl.textContent = '';
  await saveUser(false);
});

/* ---- Paystack (VIP) button ----
   Expects startPaystackSubscription(email, callback)
   callback receives: (success:boolean, data?)
*/
paystackBtn.addEventListener('click', async ()=>{
  const email = emailInput.value.trim().toLowerCase();
  const chatId = cleanChatId(chatIdInput.value.trim());
  if(!email){
    messageEl.textContent = 'Enter email before making VIP payment.';
    return;
  }
  if(!startPaystackSubscription){
    messageEl.textContent = 'Paystack module not found. Please ensure paystack.js exists.';
    return;
  }
  paystackSpinner.style.display = 'inline-block';
  paystackBtn.disabled = true;
  try{
    // startPaystackSubscription should show Paystack UI and call callback on completion
    await startPaystackSubscription(email, async (success, info) => {
      paystackSpinner.style.display = 'none';
      paystackBtn.disabled = false;
      if(success){
        try{
          const uidKey = sanitizeKey(email);
          const userRef = doc(db,"users",uidKey);
          const now = new Date().toISOString();
          const subscriptionEnd = new Date(Date.now() + 169*60*60*1000).toISOString(); // 169 hours
          await updateDoc(userRef, {
            subscriptionActive: true,
            subscriptionActivatedAt: now,
            subscriptionEnd: subscriptionEnd,
            vipName: chatId || null
          });
          // store autologin
          localStorage.setItem('currentUser', uidKey);
          // redirect to shop
          window.location.href = 'nushop.html';
        }catch(e){ console.error('Error activating VIP after payment', e); messageEl.textContent = '❌ Error activating VIP.'; }
      } else {
        messageEl.textContent = '❌ Payment unsuccessful or cancelled.';
      }
    });
  }catch(err){
    console.error('Paystack call error', err);
    paystackSpinner.style.display = 'none';
    paystackBtn.disabled = false;
    messageEl.textContent = '❌ Payment module error.';
  }
});

/* ---- optional: on page load check paystack lib presence (if needed) ---- */
if(!startPaystackSubscription){
  // leave paystackContainer hidden until VIP signup; but still show an inline message if user clicks
}

/* ---- finished ---- */
</script>
</body>
</html>