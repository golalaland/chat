<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>VIP / Host Signup</title>
<style>
:root {
  --primary-color: #ff4081;
  --background-gradient: linear-gradient(135deg,#111,#000,#222);
  --text-color: #eee;
  --input-bg: #222;
  --input-border: #333;
  --vip-color: gold;
  --fomo-bg: #000;
}
* { box-sizing:border-box; margin:0; padding:0; }
body { background: var(--background-gradient); color: var(--text-color); font-family: 'Inter', sans-serif; display:flex; flex-direction:column; align-items:center; padding:1rem; }
h2 { font-size:1.2rem; color:var(--primary-color); margin-bottom:0.25rem; text-align:center; }
.form-group { width:90%; max-width:400px; margin-bottom:0.7rem; display:flex; flex-direction:column; align-items:center; }
.form-group input { width:100%; padding:0.65rem 1rem; border-radius:30px; border:1px solid var(--input-border); background:var(--input-bg); color:var(--text-color); font-size:0.9rem; outline:none; }
.form-group input:focus { border-color: var(--primary-color); box-shadow:0 0 8px rgba(255,64,129,0.5); }
.gender-label { text-align:center; font-weight:600; font-size:0.75rem; margin-bottom:0.3rem; }
.gender-select { display:flex; justify-content:center; gap:15px; margin-bottom:1rem; }
.gender-select button { width:50px; height:50px; border-radius:50%; border:none; background:#333; color:#eee; font-weight:bold; font-size:1rem; cursor:pointer; box-shadow:0 6px #000; transition:0.2s; }
.gender-select button:active { transform:translateY(3px); box-shadow:0 2px #000; }
.gender-select button.selected { background:var(--primary-color); box-shadow:0 0 15px var(--primary-color); }
.dob-container { display:flex; flex-direction:column; align-items:center; margin-bottom:0.7rem; }
.dob-label { margin-bottom:0.3rem; font-size:0.75rem; text-align:center; }
.dob-input { width:140px; padding:0.5rem 0.8rem; border-radius:8px; border:1px solid var(--input-border); background:var(--input-bg); color:var(--text-color); font-size:0.85rem; text-align:center; cursor:pointer; }
.vip-label { text-align:center; font-weight:bold; font-size:0.85rem; margin-bottom:0.3rem; color:#aaa; transition:0.3s; }
.vip-toggle { width:80px; height:36px; border-radius:18px; background:#444; position:relative; cursor:pointer; margin:0 auto 0.5rem auto; transition:0.3s; }
.vip-toggle .vip-circle { width:34px; height:34px; border-radius:50%; background:#555; position:absolute; left:1px; top:1px; transition:0.3s; }
.vip-toggle.on .vip-circle { left:45px; background:gold; box-shadow:0 0 12px gold; }
.vip-message { text-align:center; font-size:0.8rem; color:gold; opacity:0; transition:0.3s; margin-bottom:1rem; }
.vip-label.on { color:gold; text-shadow:0 0 8px gold; }
.submit-btn { width:50%; padding:0.65rem; border:none; border-radius:30px; font-weight:bold; font-size:0.9rem; color:#fff; background:var(--primary-color); cursor:pointer; margin-bottom:1rem; transition:0.2s; display:flex; justify-content:center; align-items:center; position:relative; }
.submit-btn:hover { transform:scale(1.03); }
.submit-btn .spinner { width:18px; height:18px; border:3px solid #fff; border-top:3px solid rgba(255,255,255,0.3); border-radius:50%; animation: spin 0.7s linear infinite; display:none; }
@keyframes spin { 0%{transform:rotate(0deg);} 100%{transform:rotate(360deg);} }
.message { text-align:center; font-size:0.85rem; min-height:20px; margin-top:0.5rem; }
.fomo-popup { position:fixed; top:100px; left:50%; transform:translateX(-50%); background:#111; color:#fff; padding:0.6rem 1rem; border-radius:8px; opacity:0; transition:opacity 0.5s; pointer-events:none; font-size:0.85rem; z-index:10000; display:flex; align-items:center; gap:0.4rem; white-space:nowrap; }
.image-placeholder { width:300px; height:300px; background:#333; border-radius:15px; margin-bottom:1rem; display:flex; align-items:center; justify-content:center; font-size:1rem; color:#aaa; }
footer { width:100%; text-align:center; margin-top:2rem; font-size:0.8rem; color:#aaa; }
#paystackContainer { display:none; justify-content:center; width:100%; margin-bottom:1rem; }
#paystackBtn { width:50%; max-width:250px; padding:0.65rem; border:none; border-radius:30px; font-weight:bold; font-size:0.9rem; color:#000; background:linear-gradient(45deg,gold,#ffd700); cursor:pointer; display:flex; justify-content:center; align-items:center; position:relative; transition:0.2s; z-index:10; }
#paystackBtn:hover { transform: scale(1.03); }
#paystackSpinner { width:18px; height:18px; border:3px solid #fff; border-top:3px solid rgba(255,255,255,0.3); border-radius:50%; animation:spin 0.7s linear infinite; display:none; margin-left:8px; }
.small-note{font-size:0.75rem;color:#aaa;margin-bottom:0.6rem;}
</style>
</head>
<body>

<div class="image-placeholder">Image Placeholder</div>
<h2>VIP / Host Signup</h2>

<div class="fomo-popup" id="fomoPopup"></div>

<div class="form-group"><input id="name" type="text" placeholder="Full Name"></div>
<div class="form-group"><input id="chatId" type="text" placeholder="Choose a Chat Name"></div>
<div class="form-group"><input id="phone" type="text" placeholder="Phone Number"></div>
<div class="form-group"><input id="email" type="email" placeholder="Email Address"></div>

<div class="gender-label">Select Your Gender</div>
<div class="gender-select">
  <button id="femaleBtn">F</button>
  <button id="maleBtn">M</button>
</div>

<div class="dob-container">
  <div class="dob-label">Select Your Birth Date</div>
  <input id="dob" type="date" class="dob-input" max="">
</div>

<!-- extra fields requested -->
<div class="form-group"><input id="bankName" type="text" placeholder="Bank Name (optional)"></div>
<div class="form-group"><input id="bankAccount" type="text" placeholder="Bank Account Number (optional)"></div>
<div class="form-group"><input id="displayName" type="text" placeholder="Display Name (optional)"></div>
<div class="form-group"><input id="profilePic" type="text" placeholder="Profile Pic URL (optional)"></div>
<div class="form-group"><input id="bio" type="text" placeholder="Short Bio (optional)"></div>

<div class="vip-label" id="vipLabel">VIP</div>
<div class="vip-toggle" id="vipToggle"><span class="vip-circle"></span></div>
<div class="vip-message" id="vipMessage">You're in VIP zone, way to go!</div>

<button class="submit-btn" id="submitBtn">
  <span class="btn-text">Sign Up</span>
  <span class="spinner" id="spinner"></span>
</button>

<div id="paystackContainer">
  <button class="submit-btn" id="paystackBtn">
    <span class="btn-text">VIP ACCESS</span>
    <span class="spinner" id="paystackSpinner"></span>
  </button>
</div>

<div class="message" id="message"></div>
<footer id="footer">Footer placeholder</footer>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import {
  getFirestore, doc, setDoc, getDoc, query, collection, where, getDocs, orderBy, limit,
  updateDoc, arrayUnion
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

/* ---------- Firebase config (unchanged) ---------- */
const firebaseConfig = {
  apiKey: "AIzaSyDbKz4ef_eUDlCukjmnK38sOwueYuzqoao",
  authDomain: "metaverse-1010.firebaseapp.com",
  projectId: "metaverse-1010",
  storageBucket: "metaverse-1010.appspot.com",
  messagingSenderId: "1044064238233",
  appId: "1:1044064238233:web:2fbdfb811cb0a3ba349608"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

/* ---------- DOM ---------- */
document.addEventListener('DOMContentLoaded', () => {
  let isVIP = false;
  let gender = '';
  const vipToggle = document.getElementById('vipToggle');
  const vipLabel = document.getElementById('vipLabel');
  const vipMessage = document.getElementById('vipMessage');
  const femaleBtn = document.getElementById('femaleBtn');
  const maleBtn = document.getElementById('maleBtn');
  const submitBtn = document.getElementById('submitBtn');
  const spinner = document.getElementById('spinner');
  const messageEl = document.getElementById('message');
  const nameInput = document.getElementById('name');
  const chatIdInput = document.getElementById('chatId');
  const phoneInput = document.getElementById('phone');
  const emailInput = document.getElementById('email');
  const dobInput = document.getElementById('dob');
  const fomoPopup = document.getElementById('fomoPopup');
  const paystackContainer = document.getElementById('paystackContainer');
  const paystackBtn = document.getElementById('paystackBtn');
  const paystackSpinner = document.getElementById('paystackSpinner');

  const bankNameInput = document.getElementById('bankName');
  const bankAccountInput = document.getElementById('bankAccount');
  const displayNameInput = document.getElementById('displayName');
  const profilePicInput = document.getElementById('profilePic');
  const bioInput = document.getElementById('bio');

  const urlParams = new URLSearchParams(window.location.search);
  const referrer = urlParams.get('ref') || null; // inviter email (as-is)
  const validEmailSuffixes = ['@gmail.com','@yahoo.com','@icloud.com','@proton.me','@protonmail.com'];

  /* ---------- Helpers ---------- */
  function sanitizeKey(key){ return key.replace(/[.#$[\]]/g, ','); }
  function cleanChatId(input){ return input.toLowerCase().replace(/[^a-z0-9_]/g, ''); }
  function isValidEmail(email) { return validEmailSuffixes.some(s => email.endsWith(s)); }
  function calculateAge(dobStr){ const dob = new Date(dobStr); const diffMs = Date.now() - dob.getTime(); const ageDt = new Date(diffMs); return Math.abs(ageDt.getUTCFullYear() - 1970); }
  async function isChatIdTaken(chatId) { if(!chatId) return false; const q = query(collection(db, "users"), where("chatIdLower", "==", chatId.toLowerCase())); const snapshot = await getDocs(q); return !snapshot.empty; }
  function generateRefCode(len=6){ return Math.random().toString(36).substring(2,2+len).toUpperCase(); }

  /* ---------- Clean inputs ---------- */
  phoneInput.addEventListener('input', () => { phoneInput.value = phoneInput.value.replace(/\D/g,''); });

  /* ---------- VIP toggle ---------- */
  vipToggle.addEventListener('click', () => {
    isVIP = !isVIP;
    vipToggle.classList.toggle('on', isVIP);
    vipLabel.classList.toggle('on', isVIP);
    vipMessage.style.opacity = isVIP ? '1' : '0';
    if(isVIP) triggerSprayConfetti();
  });

  /* ---------- Gender buttons ---------- */
  femaleBtn.addEventListener('click', () => { gender='Female'; femaleBtn.classList.add('selected'); maleBtn.classList.remove('selected'); });
  maleBtn.addEventListener('click', () => { gender='Male'; maleBtn.classList.add('selected'); femaleBtn.classList.remove('selected'); });

  /* ---------- DOB max ---------- */
  const today = new Date();
  const maxDate = new Date(today.getFullYear()-18, today.getMonth(), today.getDate());
  dobInput.max = maxDate.toISOString().split('T')[0];

  /* ---------- Confetti ---------- */
  function triggerSprayConfetti() {
    const colors = ['#FFD700','#FF69B4','#00BFFF','#FF4500','#32CD32'];
    const numParticles = 50;
    const rect = vipToggle.getBoundingClientRect();
    const startX = rect.left + rect.width/2;
    const startY = rect.bottom;
    for (let i = 0; i < numParticles; i++) {
      const particle = document.createElement('div');
      particle.style.position='fixed';
      particle.style.width='6px';
      particle.style.height='16px';
      particle.style.backgroundColor=colors[Math.floor(Math.random()*colors.length)];
      particle.style.left=`${startX}px`;
      particle.style.top=`${startY}px`;
      particle.style.opacity='0.9';
      particle.style.borderRadius='2px';
      particle.style.pointerEvents='none';
      particle.style.zIndex='9999';
      document.body.appendChild(particle);
      const angle = (Math.random()*Math.PI/2) - Math.PI/4;
      const speed = 300 + Math.random()*200;
      const duration = 1500 + Math.random()*500;
      const start = performance.now();
      (function animate(time){
        const t = (time-start)/duration;
        if(t<1){
          const dx = Math.sin(angle)*speed*t;
          const dy = -Math.cos(angle)*speed*t;
          particle.style.transform=`translate(${dx}px, ${dy}px) rotate(${t*720}deg)`;
          particle.style.opacity=`${1-t}`;
          requestAnimationFrame(animate);
        } else { particle.remove(); }
      })(start);
    }
  }

  /* ---------- FOMO ---------- */
  async function fetchRecentUsers() {
    try {
      const q = query(collection(db,"users"), orderBy("createdAt","desc"), limit(10));
      const snapshot = await getDocs(q);
      const users = [];
      snapshot.forEach(docSnap=>{
        const data = docSnap.data();
        users.push({
          fullName: data.fullName || data.displayName || data.chatId,
          isVIP: !!data.isVIP,
          chatId: data.chatId || 'Anon',
          usernameColor: data.usernameColor || '#fff'
        });
      });
      return users;
    } catch(e) {
      console.error('FOMO fetch error', e);
      return [];
    }
  }

  async function showFOMO() {
    const users = await fetchRecentUsers();
    if(users.length===0) return;
    let index = 0;
    setInterval(()=>{
      const u = users[index % users.length];
      fomoPopup.innerHTML = `<span style="font-weight:bold;color:${u.usernameColor}">${u.chatId}</span> just joined as a ${u.isVIP?'VIP':'Host'} ${u.isVIP?'üéâ':'üéà'}`;
      fomoPopup.style.opacity='1';
      setTimeout(()=>{ fomoPopup.style.opacity='0'; }, 3000);
      index++;
    }, 10000);
  }
  showFOMO();

  /* ---------- Country detection ---------- */
  async function detectCountry() {
    try {
      const res = await fetch('https://ipapi.co/json/');
      const data = await res.json();
      return data.country_name || 'Unknown';
    } catch(e) {
      return 'Unknown';
    }
  }

  /* ---------- Subscription expiry check (on load & interval) ---------- */
  async function checkSubscriptionExpiryByEmail(email) {
    if(!email) return;
    const uidKey = sanitizeKey(email.toLowerCase());
    try {
      const snap = await getDoc(doc(db,"users",uidKey));
      if(!snap.exists()) return;
      const data = snap.data();
      if(data.subscriptionActive && data.subscriptionEnd){
        const expiry = new Date(data.subscriptionEnd);
        if(new Date() >= expiry){
          await updateDoc(doc(db,"users",uidKey), { subscriptionActive:false, subscriptionEnd:null });
          // update localStorage if present
          const stored = localStorage.getItem('vipUser');
          if(stored){
            const u = JSON.parse(stored);
            if(u.email && sanitizeKey(u.email) === uidKey){
              u.subscriptionActive = false;
              u.subscriptionEnd = null;
              localStorage.setItem('vipUser', JSON.stringify(u));
            }
          }
        }
      }
    } catch(e){ console.error('checkExpiry error', e); }
  }

  // run expiry check if we have a stored user
  const storedUser = localStorage.getItem('vipUser');
  if(storedUser){
    try{
      const su = JSON.parse(storedUser);
      if(su && su.email) checkSubscriptionExpiryByEmail(su.email);
    }catch(e){}
  }
  // periodic check (every 30 minutes)
  setInterval(()=>{
    const s = localStorage.getItem('vipUser');
    if(s){ try{ const u=JSON.parse(s); if(u && u.email) checkSubscriptionExpiryByEmail(u.email); }catch(e){} }
  }, 30*60*1000);

  /* ---------- Save user ---------- */
  async function saveUser(isVipPaid=false){
    spinner.style.display='inline-block';
    submitBtn.querySelector('.btn-text').style.display='none';
    submitBtn.disabled = true;

    const fullName = nameInput.value.trim();
    const chatId = cleanChatId(chatIdInput.value.trim());
    const phone = phoneInput.value.trim();
    const email = emailInput.value.trim().toLowerCase();
    const dob = dobInput.value;
    const age = calculateAge(dob);
    const uidKey = sanitizeKey(email);

    // Enforce female-only hosts (non-VIP)
    if(!isVIP && gender !== 'Female'){
      spinner.style.display='none';
      submitBtn.querySelector('.btn-text').style.display='inline';
      submitBtn.disabled = false;
      messageEl.textContent = '‚ùå Only females can sign up as hosts (non-VIP).';
      return;
    }

    // Determine hostName as inviter's chatId if present
    let hostNameValue = chatId;
    if(referrer){
      try {
        const refDocKey = sanitizeKey(referrer);
        const refSnap = await getDoc(doc(db,"users",refDocKey));
        if(refSnap.exists()){
          const refData = refSnap.data();
          if(refData && refData.chatId) hostNameValue = refData.chatId;
        }
      } catch(e){ console.warn('hostName lookup failed', e); }
    }

    // Detect country
    const country = await detectCountry();

    // Generate random usernameColor if not present
    const usernameColor = '#'+Math.floor(Math.random()*16777215).toString(16).padStart(6,'0');

    // Generate ref code
    const refCode = generateRefCode(6);

    const userData = {
      chatId,
      chatIdLower: chatId.toLowerCase(),
      fullName,
      displayName: displayNameInput.value.trim() || fullName,
      profilePic: profilePicInput.value.trim() || '',
      bio: bioInput.value.trim() || '',
      socialLinks: [],
      stars:50,
      starsToday:0,
      starsGifted:0,
      lastStarDate: new Date().toISOString().split("T")[0],
      cash:0,
      usernameColor,
      isAdmin:false,
      isVIP:isVIP,
      isHost: !isVIP,
      vipName: isVIP ? chatId : null,
      hostLink: !isVIP ? `https://golalaland.github.io/chat/ref.html?ref=${encodeURIComponent(chatId)}` : null,
      hostName: hostNameValue,
      invitedBy: referrer || null, // inviter email as-is
      dob,
      age,
      gender,
      email,
      phone,
      bankName: bankNameInput.value.trim() || '',
      bankAccountNumber: bankAccountInput.value.trim() || '',
      country,
      socialShare: !isVIP,
      subscriptionActive: isVIP ? false : true, // hosts get active true by default, VIP will activate after payment
      subscriptionEnd: isVIP ? null : null, // VIP: set after payment; host: no subscriptionEnd
      createdAt: new Date().toISOString(),
      refCode,
      emailVerified:false,
      phoneVerified:false,
    };

    try{
      await setDoc(doc(db,"users",uidKey), userData);

      // Referral bonus (based on selection; earlier working code used isVIP ? 100 : 50)
      if(referrer){
        try{
          const refDocKey = sanitizeKey(referrer);
          const refDocRef = doc(db,"users",refDocKey);
          const refSnap = await getDoc(refDocRef);
          if(refSnap.exists()){
            const refData = refSnap.data();
            const bonus = isVipPaid ? 100 : (isVIP ? 100 : 50);
            await updateDoc(refDocRef,{
              stars: (refData.stars || 0) + bonus,
              starsGifted: (refData.starsGifted || 0) + bonus,
              hostFriends: arrayUnion({
                chatId,
                chatIdLower: chatId.toLowerCase(),
                email,
                isVIP,
                gifted: bonus,
                hostLink: refData.hostLink || null,
                invitedBy: referrer
              }),
            });
            // Try increment counts (best-effort: read then update)
            // Note: we avoid race conditions with atomic increments here for brevity
            // If you want exact increments, implement with transactions or Cloud Function.
          }
        }catch(e){ console.warn('referrer update failed', e); }
      }

      // Save for auto-login (minimal safe fields)
      localStorage.setItem('vipUser', JSON.stringify({
        email,
        chatId,
        isVIP,
        subscriptionActive: userData.subscriptionActive,
        subscriptionEnd: userData.subscriptionEnd || null
      }));

      spinner.style.display='none';
      submitBtn.querySelector('.btn-text').style.display='inline';
      submitBtn.disabled = false;

      // Hide signup button to prevent reclick
      submitBtn.style.display = 'none';
      messageEl.textContent = "‚úÖ Signup successful!";

      // Show VIP access if selected, else redirect host
      if(isVIP){
        paystackContainer.style.display = 'flex';
      } else {
        // Hosts redirected
        window.location.href = 'nushop.html';
      }

    } catch(e){
      console.error('saveUser error', e);
      spinner.style.display='none';
      submitBtn.querySelector('.btn-text').style.display='inline';
      submitBtn.disabled = false;
      messageEl.textContent = "‚ùå Signup failed.";
    }
  }

  /* ---------- Signup click ---------- */
  submitBtn.addEventListener('click', async ()=>{
    messageEl.textContent = '';
    const fullName = nameInput.value.trim();
    const chatId = chatIdInput.value.trim();
    const phone = phoneInput.value.trim();
    const email = emailInput.value.trim().toLowerCase();
    const dob = dobInput.value;
    if(!fullName||!chatId||!phone||!email||!gender||!dob){ messageEl.textContent='Please fill all fields.'; return; }

    const age = calculateAge(dob);
    if(age < 18){ messageEl.textContent='‚ùå Must be 18+'; return; }
    if(!isValidEmail(email)){ messageEl.textContent='Invalid email domain'; return; }

    // ChatId length/format
    const cleanChat = cleanChatId(chatId);
    if(cleanChat.length < 5 || cleanChat.length > 15){ messageEl.textContent='Username must be 5-15 characters (a-z,0-9,_).'; return; }

    // Only females as hosts (if not VIP)
    if(!isVIP && gender !== 'Female'){ messageEl.textContent='Only females can sign up as hosts.'; return; }

    try {
      const uidKey = sanitizeKey(email);
      const userRef = doc(db, "users", uidKey);
      const existingSnap = await getDoc(userRef);
      const chatTaken = await isChatIdTaken(cleanChat);
      if (existingSnap.exists() || chatTaken) { messageEl.textContent = "‚ùå Email or chat name already taken"; return; }

      await saveUser(false);

    } catch(e){
      console.error(e);
      messageEl.textContent="‚ùå Signup failed.";
    }
  });

  /* ---------- Paystack VIP access (subscription plan) ---------- */
  paystackBtn.addEventListener('click', async ()=>{
    // Ensure user signed up
    const stored = localStorage.getItem('vipUser');
    if(!stored){ messageEl.textContent='Please sign up first.'; return; }
    const u = JSON.parse(stored);
    if(!u.email){ messageEl.textContent='Please sign up with a valid email.'; return; }

    paystackSpinner.style.display='inline-block';
    paystackBtn.querySelector('.btn-text').style.display='none';
    paystackBtn.disabled = true;

    // Launch Paystack inline for subscription plan (using your plan id)
    const handler = window.PaystackPop.setup({
      key:'pk_test_9446fa6b81888ffce77cc94294530d761aac4ccd', // keep test key or swap for live
      email: u.email,
      plan: 'PLN_grrpmsot7duff3v', // your plan code
      metadata: {
        custom_fields: [
          { display_name: 'Chat ID', variable_name: 'chat_id', value: u.chatId }
        ]
      },
      onClose: () => {
        paystackSpinner.style.display='none';
        paystackBtn.querySelector('.btn-text').style.display='inline';
        paystackBtn.disabled = false;
        messageEl.textContent = 'Payment cancelled';
      },
      callback: async function(response){
        try {
          // Payment success -> update Firestore subscription status
          const uidKey = sanitizeKey(u.email);
          const userRef = doc(db,"users",uidKey);

          // set subscriptionActive true and subscriptionEnd to +169 hours
          const now = new Date();
          const expiry = new Date(now.getTime() + 169 * 60 * 60 * 1000); // 169 hours
          await updateDoc(userRef, {
            subscriptionActive: true,
            subscriptionStart: now.toISOString(),
            subscriptionEnd: expiry.toISOString(),
            subscriptionRef: response.reference,
            vipName: u.chatId // ensure vipName stored
          });

          // update localStorage
          const storedUser = localStorage.getItem('vipUser');
          if(storedUser){
            const su = JSON.parse(storedUser);
            su.subscriptionActive = true;
            su.subscriptionEnd = expiry.toISOString();
            localStorage.setItem('vipUser', JSON.stringify(su));
          }

          paystackSpinner.style.display='none';
          paystackBtn.querySelector('.btn-text').style.display='inline';
          paystackBtn.disabled = false;
          messageEl.textContent='‚úÖ Payment successful! VIP activated.';
          // hide button and redirect
          paystackContainer.style.display='none';
          setTimeout(()=>{ window.location.href='nushop.html'; }, 1200);
        } catch(err){
          console.error('paystack callback error', err);
          paystackSpinner.style.display='none';
          paystackBtn.querySelector('.btn-text').style.display='inline';
          paystackBtn.disabled = false;
          messageEl.textContent='‚ùå Payment succeeded but activation failed. Contact support.';
        }
      }
    });

    handler.openIframe();
  });

});
</script>

<!-- Paystack inline script -->
<script src="https://js.paystack.co/v1/inline.js"></script>
</body>
</html>