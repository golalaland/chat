<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
<title>VIP / Host Signup</title>
<style>
:root {
  --primary-color: #ff4081;
  --background-gradient: linear-gradient(135deg,#111,#000,#222);
  --text-color: #eee;
  --input-bg: #222;
  --input-border: #333;
  --vip-color: gold;
}
*{box-sizing:border-box;margin:0;padding:0;}
body{background:var(--background-gradient);color:var(--text-color);font-family:'Inter',sans-serif;display:flex;flex-direction:column;align-items:center;padding:1rem;}
h2{font-size:1.2rem;color:var(--primary-color);margin-bottom:0.25rem;text-align:center;}
.form-group{width:90%;max-width:400px;margin-bottom:0.7rem;display:flex;flex-direction:column;align-items:center;}
.form-group input{width:100%;padding:0.65rem 1rem;border-radius:30px;border:1px solid var(--input-border);background:var(--input-bg);color:var(--text-color);font-size:16px;outline:none;}
.form-group input:focus{border-color: var(--primary-color);box-shadow:0 0 8px rgba(255,64,129,0.5);}
.gender-label{text-align:center;font-weight:600;font-size:0.75rem;margin-bottom:0.3rem;}
.gender-select{display:flex;justify-content:center;gap:15px;margin-bottom:1rem;}
.gender-select button{width:50px;height:50px;border-radius:50%;border:none;background:#333;color:#eee;font-weight:bold;font-size:1rem;cursor:pointer;box-shadow:0 6px #000;transition:0.2s;}
.gender-select button:active{transform:translateY(3px);box-shadow:0 2px #000;}
.gender-select button.selected{background:var(--primary-color);box-shadow:0 0 15px var(--primary-color);}
.dob-container{display:flex;flex-direction:column;align-items:center;margin-bottom:0.7rem;}
.dob-label{margin-bottom:0.3rem;font-size:0.75rem;text-align:center;}
.dob-input{width:140px;padding:0.5rem 0.8rem;border-radius:8px;border:1px solid var(--input-border);background:var(--input-bg);color:var(--text-color);font-size:16px;text-align:center;cursor:pointer;}
.vip-label{text-align:center;font-weight:bold;font-size:0.85rem;margin-bottom:0.3rem;color:#aaa;transition:0.3s;}
.vip-toggle{width:80px;height:36px;border-radius:18px;background:#444;position:relative;cursor:pointer;margin:0 auto 0.5rem auto;transition:0.3s;}
.vip-toggle .vip-circle{width:34px;height:34px;border-radius:50%;background:#555;position:absolute;left:1px;top:1px;transition:0.3s;}
.vip-toggle.on .vip-circle{left:45px;background:gold;box-shadow:0 0 12px gold;}
.vip-message{text-align:center;font-size:0.8rem;color:gold;opacity:0;transition:0.3s;margin-bottom:1rem;}
.vip-label.on{color:gold;text-shadow:0 0 8px gold;}
.submit-btn{width:50%;padding:0.65rem;border:none;border-radius:30px;font-weight:bold;font-size:0.9rem;color:#fff;background:var(--primary-color);cursor:pointer;margin-bottom:1rem;transition:0.2s;display:flex;justify-content:center;align-items:center;position:relative;}
.submit-btn:hover{transform:scale(1.03);}
.submit-btn .spinner{width:18px;height:18px;border:3px solid #fff;border-top:3px solid rgba(255,255,255,0.3);border-radius:50%;animation:spin 0.7s linear infinite;display:none;}
@keyframes spin{0%{transform:rotate(0deg);}100%{transform:rotate(360deg);}}
.message{text-align:center;font-size:0.85rem;min-height:20px;margin-top:0.5rem;}
.fomo-popup{position:fixed;top:100px;left:50%;transform:translateX(-50%);background:#111;color:#fff;padding:0.6rem 1rem;border-radius:8px;opacity:0;transition:opacity 0.5s;pointer-events:none;font-size:0.85rem;z-index:10000;display:flex;align-items:center;gap:0.4rem;white-space:nowrap;}
.image-placeholder{width:300px;height:300px;background:#333;border-radius:15px;margin-bottom:1rem;display:flex;align-items:center;justify-content:center;font-size:1rem;color:#aaa;}
footer{width:100%;text-align:center;margin-top:2rem;font-size:0.8rem;color:#aaa;}
#paystackContainer{display:none;justify-content:center;width:100%;margin-bottom:1rem;}
#paystackBtn{width:50%;max-width:250px;padding:0.65rem;border:none;border-radius:30px;font-weight:bold;font-size:0.9rem;color:#000;background:linear-gradient(45deg,gold,#ffd700);cursor:pointer;display:flex;justify-content:center;align-items:center;position:relative;transition:0.2s;z-index:10;}
#paystackBtn:hover{transform: scale(1.03);}
#paystackSpinner{width:18px;height:18px;border:3px solid #fff;border-top:3px solid rgba(255,255,255,0.3);border-radius:50%;animation:spin 0.7s linear infinite;display:none;margin-left:8px;}
</style>
</head>
<body>
<div class="image-placeholder">Image Placeholder</div>
<h2>VIP / Host Signup</h2>
<div class="fomo-popup" id="fomoPopup"></div>

<div class="form-group"><input id="name" type="text" placeholder="Full Name"></div>
<div class="form-group"><input id="chatId" type="text" placeholder="Choose a Chat Name"></div>
<div class="form-group"><input id="phone" type="text" placeholder="Phone Number"></div>
<div class="form-group"><input id="email" type="email" placeholder="Email Address"></div>
<div class="form-group"><input id="bankName" type="text" placeholder="Bank Name"></div>
<div class="form-group"><input id="bankAccount" type="text" placeholder="Bank Account Number"></div>

<div class="gender-label">Select Your Gender</div>
<div class="gender-select">
  <button id="femaleBtn">F</button>
</div>

<div class="dob-container">
  <div class="dob-label">Select Your Birth Date</div>
  <input id="dob" type="date" class="dob-input" max="">
</div>

<div class="vip-label" id="vipLabel">VIP</div>
<div class="vip-toggle" id="vipToggle"><span class="vip-circle"></span></div>
<div class="vip-message" id="vipMessage">You're in VIP zone, way to go!</div>

<button class="submit-btn" id="submitBtn">
  <span class="btn-text">Sign Up</span>
  <span class="spinner" id="spinner"></span>
</button>

<div id="paystackContainer">
  <button class="submit-btn" id="paystackBtn">
    <span class="btn-text">VIP ACCESS</span>
    <span class="spinner" id="paystackSpinner"></span>
  </button>
</div>

<div class="message" id="message"></div>
<footer id="footer">
  <div>©5786 <span>Own Your Vibe</span></div>
  <div>自分の雰囲気を楽しもう</div>
  <div>3-1-1 Nihonbashi, Chuo-ku, Tokyo, Japan</div>
  <div style="margin-top:4px;">
    <a href="#">Privacy Policy</a> |
    <a href="#">Terms of Service</a>
  </div>
</footer>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getFirestore, doc, setDoc, getDoc, query, collection, where, getDocs, updateDoc, arrayUnion, orderBy, limit } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyDbKz4ef_eUDlCukjmnK38sOwueYuzqoao",
  authDomain: "metaverse-1010.firebaseapp.com",
  databaseURL: "https://metaverse-1010-default-rtdb.firebaseio.com",
  projectId: "metaverse-1010",
  storageBucket: "metaverse-1010.appspot.com",
  messagingSenderId: "1044064238233",
  appId: "1:1044064238233:web:2fbdfb811cb0a3ba349608",
  measurementId: "G-XYZMEASURE"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

document.addEventListener('DOMContentLoaded', () => {
  let isVIP = false, gender='Female'; // female-only hosts
  const vipToggle=document.getElementById('vipToggle'), vipLabel=document.getElementById('vipLabel'), vipMessage=document.getElementById('vipMessage');
  const femaleBtn=document.getElementById('femaleBtn');
  const submitBtn=document.getElementById('submitBtn'), spinner=document.getElementById('spinner'), messageEl=document.getElementById('message');
  const nameInput=document.getElementById('name'), chatIdInput=document.getElementById('chatId');
  const phoneInput=document.getElementById('phone'), emailInput=document.getElementById('email');
  const dobInput=document.getElementById('dob'), fomoPopup=document.getElementById('fomoPopup');
  const bankNameInput=document.getElementById('bankName'), bankAccountInput=document.getElementById('bankAccount');
  const paystackContainer=document.getElementById('paystackContainer');
  const paystackBtn=document.getElementById('paystackBtn'), paystackSpinner=document.getElementById('paystackSpinner');

  const urlParams = new URLSearchParams(window.location.search);
  const referrer = urlParams.get('ref') || null;
  const validEmailSuffixes = ['@gmail.com','@yahoo.com','@icloud.com','@proton.me','@protonmail.com'];

  function sanitizeKey(key){ return key.replace(/[.#$[\]]/g, ','); }
  function cleanChatId(input){ return input.toLowerCase().replace(/[^a-z0-9_]/g, ''); }
  function isValidEmail(email){ return validEmailSuffixes.some(s => email.endsWith(s)); }
  function calculateAge(dobStr){ const dob=new Date(dobStr); const diff=Date.now()-new Date(dobStr).getTime(); return Math.abs(new Date(diff).getUTCFullYear()-1970); }
  async function isChatIdTaken(chatId){ const q=query(collection(db,"users"),where("chatIdLower","==",chatId.toLowerCase())); const snap=await getDocs(q); return !snap.empty; }

  phoneInput.addEventListener('input',()=>{ phoneInput.value=phoneInput.value.replace(/\D/g,''); });

  vipToggle.addEventListener('click',()=>{
    isVIP=!isVIP;
    vipToggle.classList.toggle('on',isVIP);
    vipLabel.classList.toggle('on',isVIP);
    vipMessage.style.opacity=isVIP?'1':'0';
    if(isVIP) triggerSprayConfetti();
  });

  const today=new Date(); dobInput.max=new Date(today.getFullYear()-18,today.getMonth(),today.getDate()).toISOString().split('T')[0];

  function triggerSprayConfetti(){
    const colors=['#FFD700','#FF69B4','#00BFFF','#FF4500','#32CD32'];
    const num=50; const rect=vipToggle.getBoundingClientRect();
    const startX=rect.left+rect.width/2, startY=rect.bottom;
    for(let i=0;i<num;i++){
      const p=document.createElement('div');
      p.style.position='fixed'; p.style.width='6px'; p.style.height='16px'; p.style.backgroundColor=colors[Math.floor(Math.random()*colors.length)];
      p.style.left=`${startX}px`; p.style.top=`${startY}px`; p.style.opacity='0.9'; p.style.borderRadius='2px'; p.style.pointerEvents='none'; p.style.zIndex='9999';
      document.body.appendChild(p);
      const angle=(Math.random()*Math.PI/2)-Math.PI/4;
      const speed=300+Math.random()*200;
      const dur=1500+Math.random()*500;
      const start=performance.now();
      (function anim(time){const t=(time-start)/dur;if(t<1){const dx=Math.sin(angle)*speed*t; const dy=-Math.cos(angle)*speed*t; p.style.transform=`translate(${dx}px,${dy}px) rotate(${t*720}deg)`; p.style.opacity=`${1-t}`; requestAnimationFrame(anim);} else{p.remove();}})(start);
    }
  }

  async function fetchRecentUsers(){
    const q=query(collection(db,"users"),orderBy("createdAt","desc"),limit(10));
    const snap=await getDocs(q);
    const users=[]; snap.forEach(d=>{ const data=d.data(); users.push({fullName:data.fullName,isVIP:data.isVIP,chatId:data.chatId,usernameColor:data.usernameColor}); });
    return users;
  }

  async function showFOMO(){
    const users=await fetchRecentUsers(); if(users.length===0) return;
    let index=0; setInterval(()=>{ const u=users[index%users.length]; fomoPopup.innerHTML=`<span style="font-weight:bold;color:${u.usernameColor}">${u.chatId}</span> just joined as a ${u.isVIP?'VIP':'Host'} ${u.isVIP?'🎉':'🎈'}`; fomoPopup.style.opacity='1'; setTimeout(()=>{ fomoPopup.style.opacity='0'; },3000); index++; },10000);
  }
  showFOMO();

  function generateRefCode(length=6){ return Math.random().toString(36).substring(2,2+length).toUpperCase(); }

  async function saveUser(isVipPaid=false){
    spinner.style.display='inline-block';
    submitBtn.querySelector('.btn-text').style.display='none';
    submitBtn.disabled=true;

    const fullName=nameInput.value.trim();
    const chatId=cleanChatId(chatIdInput.value.trim());
    const phone=phoneInput.value.trim();
    const email=emailInput.value.trim().toLowerCase();
    const dob=dobInput.value;
    const age=calculateAge(dob);
    const uidKey=sanitizeKey(email);

    // hostName = inviter's chatId
    let hostNameValue = chatId;
    if(referrer){
      const refDocKey = sanitizeKey(referrer);
      const refSnap = await getDoc(doc(db,"users",refDocKey));
      if(refSnap.exists()){ hostNameValue = refSnap.data().chatId || chatId; }
    }

    const userData = {
      chatId,
      chatIdLower: chatId.toLowerCase(),
      fullName,
      stars:50,
      starsToday:0,
      starsGifted:0,
      lastStarDate:new Date().toISOString().split("T")[0],
      cash:0,
      usernameColor:'#'+Math.floor(Math.random()*16777215).toString(16),
      isAdmin:false,
      isVIP:isVIP,
      isHost:!isVIP,
      vipName:isVIP ? chatId : null,
      hostLink:!isVIP ? `https://golalaland.github.io/chat/ref.html?ref=${encodeURIComponent(chatId)}` : null,
      hostName: hostNameValue,
      invitedBy: referrer,
      dob,
      age,
      gender,
      email,
      phone,
      bankName: bankNameInput.value.trim(),
      bankAccountNumber: bankAccountInput.value.trim(),
      country:'',
      socialShare: !isVIP,
      subscriptionActive: isVIP,
      subscriptionEnd: isVIP ? new Date(Date.now() + 169*60*60*1000).toISOString() : null,
      createdAt:new Date().toISOString(),
      refCode: generateRefCode(),
      profilePic:'',
      displayName:'',
      bio:'',
      socialLinks:[],
      emailVerified:false,
      phoneVerified:false
    };

    try{
      await setDoc(doc(db,"users",uidKey),userData);

      if(referrer){
        const refDocKey = sanitizeKey(referrer);
        const refDocRef = doc(db,"users",refDocKey);
        const refSnap = await getDoc(refDocRef);
        if(refSnap.exists()){
          const refData=refSnap.data();
          const bonus=isVipPaid ? 100 : 50;
          await updateDoc(refDocRef,{
            stars: refData.stars + bonus,
            starsGifted: refData.starsGifted + bonus,
            hostFriends: arrayUnion({ chatId, chatIdLower:chatId.toLowerCase(), isVIP:isVIP, gifted:bonus }),
            hostFriendsCount: !isVIP ? (refData.hostFriendsCount||0)+1 : (refData.hostFriendsCount||0),
            hostVIP: isVIP ? (refData.hostVIP||0)+1 : (refData.hostVIP||0)
          });
        }
      }

      spinner.style.display='none';
      submitBtn.querySelector('.btn-text').style.display='inline';
      submitBtn.disabled=false;
      submitBtn.style.display='none'; // hide after click
      messageEl.textContent="✅ Signup successful!";
      if(!isVIP) window.location.href='nushop.html';
      else paystackContainer.style.display='flex';

    } catch(e){
      console.error(e);
      spinner.style.display='none';
      submitBtn.querySelector('.btn-text').style.display='inline';
      submitBtn.disabled=false;
      messageEl.textContent="❌ Error saving user. Try again.";
    }
  }

  submitBtn.addEventListener('click',()=>saveUser(false));

  paystackBtn.addEventListener('click',async()=>{
    paystackSpinner.style.display='inline-block';
    paystackBtn.querySelector('.btn-text').style.display='none';
    // call your external paystack inline JS here
    setTimeout(async()=>{
      paystackSpinner.style.display='none';
      paystackBtn.querySelector('.btn-text').style.display='inline';
      // after successful payment, mark subscriptionActive & start 169h timer
      await saveUser(true);
      messageEl.textContent="🎉 VIP payment successful!";
    },2000);
  });

  // Auto-disable subscription if expired
  async function checkSubscription(uidKey){
    const snap=await getDoc(doc(db,"users",uidKey));
    if(snap.exists()){
      const data=snap.data();
      if(data.subscriptionActive && data.subscriptionEnd && new Date(data.subscriptionEnd)<new Date()){
        await updateDoc(doc(db,"users",uidKey),{ subscriptionActive:false, subscriptionEnd:null });
      }
    }
  }

});
</script>
</body>
</html>