<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>‰πÇ‰∏®‰πÇ‰∏®Redeem</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <style>
    /* ---------- GLOBAL ---------- */
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: Arial, sans-serif;
      background: #111;
      color: #fff;
    }

    /* ---------- HEADER ---------- */
    header {
      background: #000;
      padding: 1rem;
      text-align: center;
      font-size: 1.4rem;
      font-weight: bold;
      border-bottom: 2px solid #222;
    }

    /* ---------- PROFILE CARD ---------- */
    #user-info {
      display: flex;
      justify-content: center;
      padding: 1rem;
    }
    .profile-card {
      background: #1a1a1a;
      padding: 1rem 2rem;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.4);
      text-align: center;
      min-width: 280px;
    }
    #username {
      font-weight: bold;
      font-size: 1.2rem;
      margin-bottom: 0.8rem;
    }
    .balances {
      display: flex;
      justify-content: center;
      gap: 2rem;
      flex-wrap: wrap;
    }
    .balance-item { text-align: center; }
    .balance-label {
      font-size: 0.85rem;
      color: #aaa;
      margin-bottom: 0.2rem;
    }
    .balance-value {
      font-size: 1rem;
      font-weight: bold;
      color: #ff2fa0;
    }

    /* ---------- HOST TABS ---------- */
    .host-tabs {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin: 1rem auto 0;
      background: #000;
      padding: 8px;
      border-radius: 12px;
      width: fit-content;
    }
    .tab-btn {
      background: transparent;
      border: none;
      color: #aaa;
      font-weight: bold;
      font-size: 0.9rem;
      padding: 8px 16px;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
    }
    .tab-btn:hover { color: #fff; }
    .tab-btn.active {
      background: #ff2fa0;
      color: #fff;
    }

    /* ---------- DYNAMIC PANEL ---------- */
    .tab-content {
      background: #1a1a1a;
      border-radius: 12px;
      padding: 1rem;
      margin: 1rem auto;
      width: 260px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      text-align: center;
    }
    .stat-block {
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    .stat-value {
      font-size: 1.5rem;
      font-weight: bold;
      color: #ff2fa0;
    }
    .stat-label {
      font-size: 0.85rem;
      color: #ccc;
    }

    /* ---------- SHOP GRID ---------- */
    .shop-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
      gap: 1rem;
      padding: 1rem;
    }
    .product-card {
      position: relative;
      background: #1a1a1a;
      border-radius: 12px;
      text-align: center;
      padding: 1rem;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      transition: transform 0.2s;
    }
    .product-card:hover { transform: translateY(-5px); }
    .product-card img {
      width: 100%;
      max-height: 120px;
      object-fit: cover;
      border-radius: 10px;
    }
    .product-card h3 {
      margin: 0.7rem 0 0.3rem;
      font-size: 1rem;
      color: #fff;
    }
    .product-card .price {
      font-size: 0.9rem;
      margin-bottom: 0.6rem;
      font-weight: bold;
      color: #ccc;
    }
    .buy-btn {
      background: #ff2fa0;
      color: #fff;
      border: none;
      padding: 0.5rem 1rem;
      font-size: 0.85rem;
      border-radius: 6px;
      cursor: pointer;
      transition: background 0.2s;
    }
    .buy-btn:hover { background: #ff66d6; }

    /* ---------- AVAILABILITY BADGE ---------- */
    .availability-badge {
      position: absolute;
      top: 8px;
      right: 8px;
      background: #ff2fa0;
      color: #fff;
      font-weight: bold;
      font-size: 0.75rem;
      padding: 0.3rem 0.6rem;
      border-radius: 6px;
    }

    /* ---------- MODAL ---------- */
    #confirmModal {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.6);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }
    #confirmModal .modal-content {
      background: #1a1a1a;
      padding: 18px 20px;
      border-radius: 12px;
      max-width: 300px;
      text-align: center;
      box-shadow: 0 6px 18px rgba(0,0,0,0.4);
      animation: popIn 0.2s forwards;
    }
    #confirmModal h3 { margin-top: 0; font-size: 1.1rem; }
    #confirmModal p { font-size: 0.9rem; margin: 10px 0 15px; color: #ccc; }
    #confirmModal button {
      background: #ff2fa0;
      color: #fff;
      border: none;
      padding: 0.5rem 1rem;
      font-weight: bold;
      font-size: 0.9rem;
      border-radius: 6px;
      cursor: pointer;
      margin: 0 6px;
      min-width: 90px;
    }
    #confirmModal #confirmNo {
      background: #333;
      color: #ddd;
    }
    #confirmModal #confirmNo:hover { background: #555; }
    #confirmModal button:hover { background: #ff66d6; }

    @keyframes popIn {
      from { transform: scale(0.8); opacity: 0; }
      to { transform: scale(1); opacity: 1; }
    }

    /* ---------- HOME BUTTON ---------- */
    #home-btn {
      background: #ff2fa0;
      color: #fff;
      border: none;
      padding: 0.7rem 2rem;
      font-size: 1rem;
      font-weight: bold;
      border-radius: 6px;
      cursor: pointer;
      display: block;
      margin: 1.5rem auto;
      transition: background 0.2s;
    }
    #home-btn:hover { background: #ff66d6; }
  </style>
</head>
<body>

  <!-- HEADER -->
  <header>‰πÇ‰∏®‰πÇ‰∏®Redeem</header>

  <!-- USER INFO -->
  <div id="user-info">
    <div class="profile-card">
      <div id="username">Guest</div>
      <div class="balances">
        <div class="balance-item">
          <div class="balance-label">Stars Balance</div>
          <div class="balance-value" id="stars-count">0 ‚≠êÔ∏è</div>
        </div>
        <div class="balance-item">
          <div class="balance-label">Cash Balance</div>
          <div class="balance-value" id="cash-count">‚Ç¶0</div>
        </div>
      </div>
    </div>
  </div>

  <!-- HOST TABS -->
  <div class="host-tabs">
    <button class="tab-btn active" data-tab="vip">VIP</button>
    <button class="tab-btn" data-tab="friends">Friends</button>
    <button class="tab-btn" data-tab="badges">Badges</button>
  </div>

  <!-- DYNAMIC PANEL -->
  <div id="tab-content" class="tab-content">
    <div class="stat-block">
      <div class="stat-value">0</div>
      <div class="stat-label">VIPs Signed Up</div>
    </div>
  </div>

  <!-- SHOP GRID -->
  <div class="shop-grid">
    <div class="product-card">
      <span class="availability-badge">3 Left</span>
      <img src="item1.jpg" alt="Product 1">
      <h3>Exclusive Cube</h3>
      <p class="price">‚Ç¶2,500</p>
      <button class="buy-btn">Purchase</button>
    </div>
    <div class="product-card">
      <span class="availability-badge">5 Left</span>
      <img src="item2.jpg" alt="Product 2">
      <h3>Luxury Drink</h3>
      <p class="price">‚Ç¶4,000</p>
      <button class="buy-btn">Purchase</button>
    </div>
    <div class="product-card">
      <span class="availability-badge">1 Left</span>
      <img src="item3.jpg" alt="Product 3">
      <h3>Gold Package</h3>
      <p class="price">‚Ç¶7,500</p>
      <button class="buy-btn">Purchase</button>
    </div>
  </div>

  <!-- HOME BUTTON -->
  <button id="home-btn" onclick="location.href='index.html'">Take Me Home</button>

  <!-- CONFIRM PURCHASE MODAL -->
  <div id="confirmModal">
    <div class="modal-content">
      <h3>Confirm Purchase</h3>
      <p>Are you sure you want to buy this item?</p>
      <button id="confirmYes">Yes</button>
      <button id="confirmNo">No</button>
    </div>
  </div>

  <script>
    // Tab switch
    const tabBtns = document.querySelectorAll(".tab-btn");
    const tabContent = document.getElementById("tab-content");

    tabBtns.forEach(btn => {
      btn.addEventListener("click", () => {
        tabBtns.forEach(b => b.classList.remove("active"));
        btn.classList.add("active");
        let type = btn.getAttribute("data-tab");

        if (type === "vip") {
          tabContent.innerHTML = `
            <div class="stat-block">
              <div class="stat-value">0</div>
              <div class="stat-label">VIPs Signed Up</div>
            </div>`;
        } else if (type === "friends") {
          tabContent.innerHTML = `
            <div class="stat-block">
              <div class="stat-value">0</div>
              <div class="stat-label">Friends Added</div>
            </div>`;
        } else {
          tabContent.innerHTML = `
            <div class="stat-block">
              <div class="stat-value">Gold</div>
              <div class="stat-label">Badge Status</div>
            </div>`;
        }
      });
    });

    // Modal
    const modal = document.getElementById("confirmModal");
    const buyBtns = document.querySelectorAll(".buy-btn");
    const confirmYes = document.getElementById("confirmYes");
    const confirmNo = document.getElementById("confirmNo");

    buyBtns.forEach(btn => {
      btn.addEventListener("click", () => {
        modal.style.display = "flex";
      });
    });
    confirmNo.addEventListener("click", () => { modal.style.display = "none"; });
    confirmYes.addEventListener("click", () => {
      alert("Purchase confirmed!"); // üî• replace later with Firestore logic
      modal.style.display = "none";
    });
  </script>
</body>
</html>

<script type="module">
// ---------- Firebase ----------
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { 
  getFirestore, doc, getDoc, onSnapshot, collection, getDocs, runTransaction
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyDbKz4ef_eUDlCukjmnK38sOwueYuzqoao",
  authDomain: "metaverse-1010.firebaseapp.com",
  projectId: "metaverse-1010",
  storageBucket: "metaverse-1010.appspot.com",
  messagingSenderId: "1044064238233",
  appId: "1:1044064238233:web:2fbdfb811cb0a3ba349608",
  measurementId: "G-S77BMC266C",
  databaseURL: "https://metaverse-1010-default-rtdb.firebaseio.com/"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// ---------- DOM Refs ----------
const usernameEl = document.getElementById('username');
const starsEl = document.getElementById('stars-count');
const cashEl = document.getElementById('cash-count');
const shopItemsEl = document.getElementById('shop-items');

// ---------- Utilities ----------
function formatNumber(n){ return new Intl.NumberFormat('en-NG').format(n); }
function animateNumber(el, from, to, duration = 600) {
  const start = performance.now();
  function step(timestamp) {
    const progress = Math.min((timestamp - start) / duration, 1);
    const value = Math.floor(from + (to - from) * progress);
    if (el === starsEl) el.textContent = `${formatNumber(value)} ‚≠êÔ∏è`;
    else if (el === cashEl) el.textContent = `‚Ç¶${formatNumber(value)}`;
    if (progress < 1) requestAnimationFrame(step);
  }
  requestAnimationFrame(step);
}

// ---------- Confetti ----------
function triggerConfetti() {
  if (!window.confetti) {
    const confettiScript = document.createElement('script');
    confettiScript.src = "https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js";
    confettiScript.onload = () => {
      window.confetti && window.confetti({ particleCount: 120, spread: 80, origin: { y: 0.6 } });
    };
    document.body.appendChild(confettiScript);
  } else {
    window.confetti({ particleCount: 120, spread: 80, origin: { y: 0.6 } });
  }
}

// ---------- Modals ----------
const confirmModal = document.createElement("div");
confirmModal.id = "confirmModal";
confirmModal.style.position = "fixed";
confirmModal.style.top = "0";
confirmModal.style.left = "0";
confirmModal.style.width = "100%";
confirmModal.style.height = "100%";
confirmModal.style.background = "rgba(0,0,0,0.6)";
confirmModal.style.display = "none";
confirmModal.style.justifyContent = "center";
confirmModal.style.alignItems = "center";
confirmModal.style.zIndex = "1000";
confirmModal.innerHTML = `
  <div class="modal-content theme-popup">
    <h3 id="confirmTitle">Confirm</h3>
    <p id="confirmText"></p>
    <div class="modal-actions">
      <button id="confirmYes" class="btn btn-primary">Yes</button>
      <button id="confirmNo" class="btn btn-secondary">Cancel</button>
    </div>
  </div>
`;
document.body.appendChild(confirmModal);

function showConfirmModal(title, text, onYes) {
  document.getElementById("confirmTitle").innerText = title;
  document.getElementById("confirmText").innerText = text;
  confirmModal.style.display = "flex";
  const yesBtn = document.getElementById("confirmYes");
  const noBtn = document.getElementById("confirmNo");
  const cleanup = () => { confirmModal.style.display = "none"; yesBtn.onclick = null; noBtn.onclick = null; };
  yesBtn.onclick = () => { onYes(); cleanup(); };
  noBtn.onclick = cleanup;
}

function showMessageModal(title, text, duration = 2000) {
  document.getElementById("confirmTitle").innerText = title;
  document.getElementById("confirmText").innerText = text;
  document.getElementById("confirmYes").style.display = "none";
  document.getElementById("confirmNo").style.display = "none";
  confirmModal.style.display = "flex";
  setTimeout(() => {
    confirmModal.style.display = "none";
    document.getElementById("confirmYes").style.display = "inline-block";
    document.getElementById("confirmNo").style.display = "inline-block";
  }, duration);
}

// ---------- Current User ----------
let currentUser = null;
async function loadCurrentUser() {
  const vipSession = JSON.parse(localStorage.getItem('vipUser'));
  if(!vipSession?.email) return;
  const uid = vipSession.email.replace(/[.#$[\]]/g, ',');
  const userRef = doc(db, 'users', uid);
  const snap = await getDoc(userRef);
  if(!snap.exists()) return;

  currentUser = { uid, ...snap.data() };
  usernameEl.textContent = currentUser.chatId || 'Guest';
  starsEl.textContent = `${formatNumber(currentUser.stars || 0)} ‚≠êÔ∏è`;
  cashEl.textContent = `‚Ç¶${formatNumber(currentUser.cash || 0)}`;
  renderShop();

  onSnapshot(userRef, docSnap => {
    const data = docSnap.data();
    if(!data) return;
    const oldStars = currentUser.stars;
    const oldCash = currentUser.cash;
    currentUser.stars = Number(data.stars || 0);
    currentUser.cash = Number(data.cash || 0);
    animateNumber(starsEl, oldStars, currentUser.stars);
    animateNumber(cashEl, oldCash, currentUser.cash);
  });
}
loadCurrentUser();

// ---------- Shop Rendering ----------
function createProductCard(product) {
  const card = document.createElement("div");
  card.className = "product-card";
  card.innerHTML = `
    <img src="${product.img}" alt="${product.name}">
    <div class="availability-badge">${product.available > 0 ? product.available + ' left' : 'Sold Out'}</div>
    <div class="product-info">
      <h3 class="product-name">${product.name}</h3>
      <p class="product-cost">Cost: ${product.cost} ‚≠ê</p>
      <button class="buy-btn">Redeem</button>
    </div>
  `;
  const badge = card.querySelector(".availability-badge");
  const btn = card.querySelector(".buy-btn");
  if (product.available <= 0) {
    badge.textContent = "Sold Out";
    badge.style.background = "#999";
  }

  btn.onclick = () => {
    if (!currentUser) return showMessageModal("Oops!", "You must be logged in to purchase.");
    if (currentUser.stars < product.cost) return showMessageModal("Oops!", "Not enough stars!");
    if (product.available <= 0) return showMessageModal("Sold Out!", "This item is no longer available.");

    showConfirmModal(
      "Confirm Purchase",
      `Get "${product.name}" for ${product.cost} ‚≠ê?`,
      async () => {
        try {
          const userRef = doc(db, "users", currentUser.uid);
          const productRef = doc(db, "shopItems", product.id.toString());
          let newStars, newCash, redeemedCash = 0;

          await runTransaction(db, async (transaction) => {
            const userSnap = await transaction.get(userRef);
            const productSnap = await transaction.get(productRef);
            if (!userSnap.exists()) throw "User not found!";
            if (!productSnap.exists()) throw "Product not found!";
            const userData = userSnap.data();
            const productData = productSnap.data();
            if (Number(userData.stars) < Number(productData.cost)) throw "Not enough stars!";
            if (Number(productData.available) <= 0) throw "Out of stock!";

            newStars = Number(userData.stars) - Number(productData.cost);

            // Special handling for "Redeem Cash Balance"
            if (product.name === "Redeem Cash Balance") {
              redeemedCash = Number(userData.cash || 0);
              newCash = 0; 
            } else {
              newCash = (Number(userData.cash) || 0) + (Number(productData.cashReward) || 0);
            }

            transaction.update(userRef, { stars: newStars, cash: newCash });
            transaction.update(productRef, { available: Number(productData.available) - 1 });

            const purchaseRef = doc(collection(db, "purchases"));
            transaction.set(purchaseRef, {
              userId: currentUser.uid,
              email: userData.email || "",
              phone: userData.phone || "",
              productId: product.id,
              productName: product.name,
              cost: Number(productData.cost),
              cashReward: Number(productData.cashReward) || 0,
              redeemedCash: redeemedCash,
              timestamp: new Date()
            });
          });

          // Update UI + feedback
          animateNumber(starsEl, currentUser.stars, newStars);
          animateNumber(cashEl, currentUser.cash, newCash);
          currentUser.stars = newStars;
          currentUser.cash = newCash;
          renderShop();
          triggerConfetti();

          if (redeemedCash > 0) {
            showMessageModal("Cash Redeemed!", `‚Ç¶${formatNumber(redeemedCash)} successfully withdrawn üéâ`, 3000);
          } else {
            showMessageModal("Congratulations!", `"${product.name}" redeemed successfully! üéâ`, 2500);
          }

        } catch(e) {
          console.error("Redemption error:", e);
          showMessageModal("Error!", "Redemption failed: " + e, 2500);
        }
      }
    );
  };

  return card;
}

async function renderShop(){
  shopItemsEl.innerHTML = '';
  const querySnap = await getDocs(collection(db, 'shopItems'));
  querySnap.forEach(docSnap => {
    const data = docSnap.data();
    const item = { id: docSnap.id, ...data };
    shopItemsEl.appendChild(createProductCard(item));
  });
}
</script>