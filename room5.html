<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
<title>Xixi â€” Live Stream ðŸ’¸</title>
<link rel="icon" href="data:," />
<style>
:root{
  --bg:#000;
  --card:#111;
  --muted:#888;
  --highlight:#ff0;
}
body{
  margin:0;
  background:var(--bg);
  color:#fff;
  font-family:sans-serif;
}
#messages{height:60vh;overflow-y:auto;padding:10px;}
#sendArea{display:none;margin-top:10px;}
#profileBox{display:none;margin-top:10px;}
#adminControls{display:none;margin-top:10px;}
.modalOverlay{
  position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.8);display:flex;align-items:center;justify-content:center;z-index:999;
}
.modalContent{
  background:#111;padding:20px;border-radius:10px;text-align:center;
}
button{margin:5px;padding:5px 10px;background:#222;color:#fff;border:none;border-radius:5px;cursor:pointer;}
input{padding:5px;border-radius:5px;border:none;margin-top:5px;width:80%;}
</style>
</head>
<body>

<div id="hello">HELLO ðŸŒŸ</div>
<div id="greeting">Welcome to Xixi</div>
<div id="authBox">
  <button id="googleSignInBtn">Sign in with Google</button>
</div>

<div id="messages"></div>

<div id="sendArea">
  <input type="text" id="msgInput" placeholder="Type your message..." />
  <button id="sendBtn">Send</button>
</div>

<div id="profileBox">
  <div id="profileName"></div>
  <div>Stars: <span id="starCount">0</span></div>
  <div>Cash: <span id="cashCount">0</span></div>
</div>

<div id="adminControls">
  <button id="adminGiveStarsBtn">Give Stars</button>
  <button id="adminResetStarsBtn">Reset Stars</button>
  <button id="adminGiveCashBtn">Give Cash</button>
  <button id="adminResetCashBtn">Reset Cash</button>
  <button id="adminClearMessagesBtn">Clear Messages</button>
</div>

<!-- Firebase -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getAuth, onAuthStateChanged, signInWithPopup, GoogleAuthProvider } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
import { getFirestore, doc, setDoc, getDoc, updateDoc, onSnapshot, collection, addDoc, query, orderBy, limit } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

// ------------------ INIT ------------------
const firebaseConfig = {
Â  apiKey: "AIzaSyDbKz4ef_eUDlCukjmnK38sOwueYuzqoao",
Â  authDomain: "metaverse-1010.firebaseapp.com",
Â  projectId: "metaverse-1010",
Â  storageBucket: "metaverse-1010.firebasestorage.app",
Â  messagingSenderId: "1044064238233",
Â  appId: "1:1044064238233:web:2fbdfb811cb0a3ba349608",
Â  measurementId: "G-S77BMC266C"
};
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

let currentUser = null;
let userDocUnsub = null;
let messagesUnsub = null;
const userColors = {};

// ------------------ HELPER ------------------
function randomColor() {
  return '#'+Math.floor(Math.random()*16777215).toString(16);
}

function formatNumberWithCommas(x){return x.toString().replace(/\B(?=(\d{3})+(?!\d))/g,",");}

function generateGuestName(){return "Guest"+Math.floor(Math.random()*10000);}

// ------------------ CHAT ID MODAL ------------------
async function promptForChatIDModal(userRef, userData){
  if(userData.chatId) return userData.chatId;
  return new Promise((resolve)=>{
    const overlay = document.createElement("div"); overlay.className="modalOverlay";
    const modal = document.createElement("div"); modal.className="modalContent";
    modal.innerHTML=`<h2>Pick your Chat ID</h2><input id="chatIdInput" placeholder="Your Chat ID"/><br><button id="chatIdSubmit">OK</button>`;
    overlay.appendChild(modal);
    document.body.appendChild(overlay);
    const input = modal.querySelector("#chatIdInput");
    const btn = modal.querySelector("#chatIdSubmit");
    btn.onclick = async ()=>{
      const val = input.value.trim();
      if(val.length>1){
        try{await updateDoc(userRef,{chatId:val});}
        catch(e){console.warn(e);}
        document.body.removeChild(overlay);
        resolve(val);
      } else {alert("Chat ID must be at least 2 characters");}
    }
  });
}

// ------------------ SIGN IN ------------------
document.getElementById("googleSignInBtn").onclick=()=>{
  signInWithPopup(auth,new GoogleAuthProvider());
};

// ------------------ AUTH STATE ------------------
onAuthStateChanged(auth, async(user)=>{
  if(user){
    const userRef = doc(db,"users",user.uid);
    let snap = await getDoc(userRef);
    if(!snap.exists()){
      await setDoc(userRef,{
        chatId: user.displayName || generateGuestName(),
        stars:100,
        cash:0,
        usernameColor: randomColor(),
        lastColorDate:new Date().toISOString().split("T")[0],
        isAdmin:false,
        lastStarReset:Date.now()
      });
      snap = await getDoc(userRef);
    }
    let userData = snap.exists()?snap.data():{};

    // ---------- CHAT ID ----------
    userData.chatId = await promptForChatIDModal(userRef,userData);

    // ---------- DAILY COLOR ----------
    const today = new Date().toISOString().split("T")[0];
    if(!userData.lastColorDate || userData.lastColorDate!==today){
      const newColor=randomColor();
      try{await updateDoc(userRef,{usernameColor:newColor,lastColorDate:today}); userData.usernameColor=newColor;}catch(e){console.warn(e);}
    }

    // ---------- ADMIN CONTROLS ----------
    const adminControlsEl=document.getElementById("adminControls");
    if(userData.isAdmin) adminControlsEl.style.display="flex";

    // ---------- CURRENT USER ----------
    currentUser={
      uid:user.uid,
      chatId:userData.chatId||user.displayName||generateGuestName(),
      stars:userData.stars||0,
      cash:userData.cash||0,
      usernameColor:userData.usernameColor||randomColor(),
      isAdmin:userData.isAdmin||false
    };

    // ---------- UI ----------
    document.getElementById("hello").style.display="none";
    document.getElementById("greeting").style.display="none";
    document.getElementById("authBox").style.display="none";
    document.getElementById("sendArea").style.display="flex";
    document.getElementById("profileBox").style.display="block";
    document.getElementById("profileName").innerText=currentUser.chatId;
    document.getElementById("profileName").style.color=currentUser.usernameColor;
    document.getElementById("starCount").innerText=formatNumberWithCommas(currentUser.stars);
    document.getElementById("cashCount").innerText=formatNumberWithCommas(currentUser.cash);

    // ---------- USER DOC LIVE ----------
    if(userDocUnsub) userDocUnsub();
    userDocUnsub = onSnapshot(userRef,(uSnap)=>{
      const d = uSnap.data()||{};
      currentUser.stars=d.stars||0;
      currentUser.cash=d.cash||0;
      document.getElementById("starCount").innerText=formatNumberWithCommas(currentUser.stars);
      document.getElementById("cashCount").innerText=formatNumberWithCommas(currentUser.cash);
      if(d.usernameColor){
        document.getElementById("profileName").style.color=d.usernameColor;
        userColors[userRef.id]=d.usernameColor;
      }
    });

    // ---------- MESSAGES LISTENER ----------
    const messagesEl = document.getElementById("messages");
    if(messagesUnsub) messagesUnsub();
    const q = query(collection(db,"messages_livestreaming"),orderBy("timestamp","desc"),limit(100));
    messagesUnsub = onSnapshot(q,(snap)=>{
      messagesEl.innerHTML="";
      snap.docs.reverse().forEach(doc=>{
        const d = doc.data();
        const color = userColors[d.uid]||"#fff";
        const div=document.createElement("div");
        div.innerHTML=`<b style="color:${color}">${d.chatId||"Anon"}:</b> ${d.text}`;
        messagesEl.appendChild(div);
      });
      messagesEl.scrollTop=messagesEl.scrollHeight;
    });

  } else {
    currentUser=null;
    document.getElementById("hello").style.display="";
    document.getElementById("greeting").style.display="";
    document.getElementById("authBox").style.display="";
    document.getElementById("sendArea").style.display="none";
    document.getElementById("profileBox").style.display="none";
    document.getElementById("messages").innerHTML="";
    if(userDocUnsub){ userDocUnsub(); userDocUnsub=null;}
    if(messagesUnsub){ messagesUnsub(); messagesUnsub=null;}
  }
});

// ------------------ SEND MESSAGE ------------------
document.getElementById("sendBtn").onclick=async()=>{
  const val = document.getElementById("msgInput").value.trim();
  if(val && currentUser){
    await addDoc(collection(db,"messages_livestreaming"),{
      uid:currentUser.uid,
      chatId:currentUser.chatId,
      text:val,
      timestamp:Date.now()
    });
    document.getElementById("msgInput").value="";
  }
};
</script>
</body>
</html>