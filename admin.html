<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Admin Dashboard ‚Äî NNAMDI</title>
<style>
:root{
  --bg:#f5f6f8; --panel:#fff; --accent:#ff33cc; --muted:#6b7280; --text:#0f1720;
}
*{box-sizing:border-box}
body{margin:0;font-family:Inter,Arial,sans-serif;background:var(--bg);color:var(--text);height:100vh;display:flex;overflow:hidden}
.sidebar{width:220px;background:#0b1220;color:#fff;display:flex;flex-direction:column;padding:14px;gap:8px}
.sidebar h2{margin:0 0 6px 0;font-size:16px;text-align:center}
.sidebar button{background:none;border:none;color:#cbd5e1;padding:10px;border-radius:8px;text-align:left;cursor:pointer}
.sidebar button.active, .sidebar button:hover{background:var(--accent);color:#fff}
.main{flex:1;display:flex;flex-direction:column;overflow:hidden}
.topbar{height:64px;background:var(--panel);display:flex;align-items:center;justify-content:space-between;padding:0 18px;border-bottom:1px solid #e6e9ee}
.topbar .left{display:flex;align-items:center;gap:12px}
.brand{font-weight:700}
.admin-info{display:flex;gap:12px;align-items:center;font-size:14px}
.content{display:flex;flex:1;overflow:auto;padding:18px;gap:18px}
.col{flex:1;min-width:420px;max-width:1200px;overflow:auto}
.card{background:var(--panel);border-radius:10px;padding:12px;box-shadow:0 6px 18px rgba(8,12,20,0.06);margin-bottom:12px}
h3{margin:0 0 8px 0}
input,select,textarea{width:100%;padding:8px;border-radius:6px;border:1px solid #e3e7ee;margin:6px 0;font-size:14px}
.table{width:100%;border-collapse:collapse}
.table th,.table td{padding:8px;border-bottom:1px solid #eef2f6;text-align:left;font-size:13px;vertical-align:middle}
.btn{background:var(--accent);color:#fff;border:none;padding:7px 10px;border-radius:8px;cursor:pointer}
.btn.ghost{background:transparent;color:var(--muted);border:1px solid #eef2f6}
.controls{display:flex;gap:8px;flex-wrap:wrap}
.small{font-size:13px;color:var(--muted)}
.log-list, .claims-list{max-height:360px;overflow:auto;padding:0;margin:0;list-style:none}
.actions-wrap{display:flex;gap:6px;flex-wrap:wrap}
.footer{font-size:12px;color:var(--muted);text-align:center;padding:10px}
.badge{background:#eef2f6;color:#111;padding:4px 6px;border-radius:6px;font-size:12px}
</style>
</head>
<body>

<!-- Sidebar -->
<div class="sidebar">
  <h2>ADMIN</h2>
  <button data-view="rooms" class="active" onclick="navigate(event)">Rooms</button>
  <button data-view="users" onclick="navigate(event)">Users</button>
  <button data-view="shop" onclick="navigate(event)">Shop</button>
  <button data-view="purchases" onclick="navigate(event)">Purchases</button>
  <button data-view="claims" onclick="navigate(event)">Claims</button>
  <button data-view="logs" onclick="navigate(event)">Logs</button>
  <div style="flex:1"></div>
  <button data-view="meta" onclick="navigate(event)">Admin Profile</button>
</div>

<div class="main">
  <div class="topbar">
    <div class="left">
      <div class="brand">üéõÔ∏è Admin Dashboard</div>
      <div class="small">Realtime ‚Äî Firestore</div>
    </div>
    <div class="admin-info">
      <div id="adminDisplay" class="small">Not signed (admin)</div>
      <div id="adminBalances" class="small badge">‚≠ê 0 ‚Äî ‚Ç¶0</div>
      <button class="btn" onclick="refreshAll()">Refresh</button>
    </div>
  </div>

  <div class="content">
    <!-- ROOMS -->
    <div id="view-rooms" class="col">
      <div class="card">
        <h3>Rooms</h3>
        <div style="display:flex;gap:8px;">
          <select id="roomSelect"></select>
          <button class="btn" id="btnToggleMute">Toggle Mute</button>
          <button class="btn" id="btnToggleSlow">Toggle SlowChat</button>
          <button class="btn ghost" id="btnResetRoom">Reset</button>
        </div>
      </div>
      <div class="card">
        <h3>Room Stats</h3>
        <div class="small">Selected: <span id="roomName">‚Äî</span></div>
        <div style="display:flex;gap:12px;margin-top:8px">
          <div class="small">Users: <span id="roomUserCount">0</span></div>
          <div class="small">Hosts: <span id="roomHostCount">0</span></div>
          <div class="small">VIPs: <span id="roomVIPCount">0</span></div>
        </div>
      </div>
    </div>

    <!-- USERS -->
    <div id="view-users" class="col" style="display:none">
      <div class="card">
        <h3>Users</h3>
        <div style="display:flex;gap:8px;margin-bottom:8px">
          <input id="userSearch" placeholder="Search email / name / id">
          <select id="userFilter">
            <option value="all">All</option>
            <option value="hosts">Hosts</option>
            <option value="vip">VIP</option>
            <option value="banned">Banned</option>
            <option value="timedout">Timed out</option>
          </select>
          <button class="btn" onclick="loadUsers()">Search</button>
        </div>
        <table class="table">
          <thead>
            <tr>
              <th>User</th><th>Email</th><th>Phone</th><th>Invited By</th><th>Stars</th><th>Cash</th><th>Status</th><th>Actions</th>
            </tr>
          </thead>
          <tbody id="userList"></tbody>
        </table>
      </div>
    </div>

    <!-- SHOP -->
    <div id="view-shop" class="col" style="display:none">
      <div class="card">
        <h3>Shop Items</h3>
        <div style="display:flex;gap:8px;margin-bottom:8px">
          <input id="shopSearch" placeholder="Search items">
          <select id="shopViewMode"><option value="admin">Admin</option><option value="host">Host</option><option value="user">User</option></select>
          <button class="btn" onclick="loadShop()">Refresh</button>
        </div>
        <table class="table">
          <thead><tr><th>Item</th><th>Cost</th><th>Cash</th><th>Stock</th><th>HostOnly</th><th>Actions</th></tr></thead>
          <tbody id="shopList"></tbody>
        </table>
      </div>
    </div>

    <!-- PURCHASES -->
    <div id="view-purchases" class="col" style="display:none">
      <div class="card">
        <h3>Purchases</h3>
        <table class="table">
          <thead><tr><th>User</th><th>Email</th><th>Phone</th><th>Item</th><th>Stars Spent</th><th>Fulfilled</th><th>Date</th></tr></thead>
          <tbody id="purchasesList"></tbody>
        </table>
      </div>
    </div>

    <!-- CLAIMS -->
    <div id="view-claims" class="col" style="display:none">
      <div class="card">
        <h3>Claims / Refunds</h3>
        <div style="display:flex;gap:8px;margin-bottom:8px">
          <input id="claimSearch" placeholder="Search by user / product / id">
          <button class="btn" onclick="loadClaims()">Refresh</button>
        </div>
        <ul class="claims-list" id="claimsList"></ul>
      </div>
    </div>

    <!-- LOGS -->
    <div id="view-logs" class="col" style="display:none">
      <div class="card">
        <h3>Action Logs</h3>
        <button class="btn" onclick="loadLogs()">Refresh</button>
        <ul class="log-list" id="logList"></ul>
      </div>
    </div>

    <!-- META -->
    <div id="view-meta" class="col" style="display:none">
      <div class="card">
        <h3>Admin Profile</h3>
        <input id="adminName" placeholder="Admin display name (chatId)">
        <input id="adminEmail" placeholder="Admin email">
        <input id="adminStars" type="number" placeholder="Stars">
        <input id="adminCash" type="number" placeholder="Cash">
        <div style="margin-top:8px"><button class="btn" onclick="saveAdminProfile()">Save</button><button class="btn ghost" onclick="loadAdminProfile()">Load</button></div>
      </div>
    </div>

  </div>
  <div class="footer">Built for NNAMDI ‚Äî secure Firestore rules before production.</div>
</div>

<!-- Firebase + JS -->
<script type="module">
import { 
  initializeApp 
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";

import { 
  getFirestore, doc, getDoc, getDocs, setDoc, updateDoc, addDoc, collection, serverTimestamp 
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

// ---------- FIREBASE CONFIG ----------
const firebaseConfig = {
  apiKey: "AIzaSyDbKz4ef_eUDlCukjmnK38sOwueYuzqoao",
  authDomain: "metaverse-1010.firebaseapp.com",
  projectId: "metaverse-1010",
  storageBucket: "metaverse-1010.appspot.com",
  messagingSenderId: "1044064238233",
  appId: "1:1044064238233:web:2fbdfb811cb0a3ba349608",
  databaseURL: "https://metaverse-1010-default-rtdb.firebaseio.com/"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// ---------- NAV ----------
window.navigate = (e)=>{
  const v = e.target.getAttribute("data-view");
  document.querySelectorAll(".sidebar button").forEach(b=>b.classList.remove("active"));
  e.target.classList.add("active");
  document.querySelectorAll(".col").forEach(c=>c.style.display="none");
  document.getElementById("view-"+v).style.display="block";
};

// ---------- USERS ----------
async function loadUsers(){
  const tbody = document.getElementById("userList");
  tbody.innerHTML = "";
  const q = await getDocs(collection(db,"users"));
  q.forEach(docSnap=>{
    const u = docSnap.data();
    const inviter = u.invitedBy ? `<a href="#" onclick="viewReferralChain('${u.invitedBy}')">${u.invitedBy}</a>` : "‚Äî";
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${u.chatId || "-"}</td>
      <td>${u.email || "-"}</td>
      <td>${u.phone || "-"}</td>
      <td>${inviter}</td>
      <td>${u.stars || 0}</td>
      <td>‚Ç¶${u.cash || 0}</td>
      <td>${u.isHost ? "Host" : u.isVIP ? "VIP" : "User"}</td>
      <td class="actions-wrap">
        <button onclick="giftStars('${docSnap.id}',10)">+10‚≠ê</button>
        <button onclick="giftCash('${docSnap.id}',5)">+5üíµ</button>
        <button onclick="timeoutUser('${docSnap.id}')">Timeout</button>
        <button onclick="banUser('${docSnap.id}')">Ban</button>
        <button onclick="kickUser('${docSnap.id}')">Kick</button>
      </td>
    `;
    tbody.appendChild(tr);
  });
}

// ---------- REFERRAL CHAIN ----------
window.viewReferralChain = async (uid, depth=0)=>{
  if(depth>5) return;
  const snap = await getDoc(doc(db,"users",uid));
  if(!snap.exists()){ alert("User not found"); return; }
  const user = snap.data();
  let chain = [user.chatId || user.email || uid];
  if(user.invitedBy){
    const parent = await getDoc(doc(db,"users",user.invitedBy));
    if(parent.exists()){
      chain.unshift(parent.data().chatId || parent.data().email || user.invitedBy);
    } else {
      chain.unshift(user.invitedBy);
    }
  }
  alert("Referral chain:\n" + chain.join(" ‚Üí "));
};

// ---------- ADMIN ACTIONS ----------
window.giftStars = async(uid,amount)=>{
  const ref = doc(db,"users",uid);
  const snap = await getDoc(ref);
  if(snap.exists()){
    const newStars = (snap.data().stars||0)+amount;
    await updateDoc(ref,{stars:newStars});
    alert(`+${amount}‚≠ê to ${snap.data().chatId}`);
    loadUsers();
  }
}
window.giftCash = async(uid,amount)=>{
  const ref = doc(db,"users",uid);
  const snap = await getDoc(ref);
  if(snap.exists()){
    const newCash = (snap.data().cash||0)+amount;
    await updateDoc(ref,{cash:newCash});
    alert(`+‚Ç¶${amount} to ${snap.data().chatId}`);
    loadUsers();
  }
}
window.timeoutUser = async(uid)=>{
  const ref = doc(db,"users",uid);
  await updateDoc(ref,{ timeoutUntil: Date.now()+5*60*1000 });
  alert(`User timed out for 5 minutes`);
}
window.banUser = async(uid)=>{ await updateDoc(doc(db,"users",uid),{banned:true}); alert("User banned"); loadUsers(); }
window.kickUser = async(uid)=>{ await updateDoc(doc(db,"users",uid),{kicked:true}); alert("User kicked"); loadUsers(); }

// ---------- PURCHASES ----------
async function loadPurchases(){
  const tbody=document.getElementById("purchasesList");
  tbody.innerHTML="";
  const q=await getDocs(collection(db,"purchases"));
  q.forEach(p=>{
    const d=p.data();
    const tr=document.createElement("tr");
    tr.innerHTML=`
      <td>${d.userId || "-"}</td>
      <td>${d.userEmail || "-"}</td>
      <td>${d.phone || "-"}</td>
      <td>${d.itemName || "-"}</td>
      <td>${d.starsSpent || 0}</td>
      <td><input type="checkbox" ${d.fulfilled?"checked":""}></td>
      <td>${d.createdAt?.toDate?d.createdAt.toDate().toLocaleString():"-"}</td>
    `;
    tbody.appendChild(tr);
  });
}

// ---------- INIT ----------
loadUsers();
loadPurchases();
</script>
</body>
</html>